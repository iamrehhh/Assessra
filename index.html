<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Habibi Studies</title>
<link rel="icon" type="image/png" href="logo.png">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet">
<style>

    /* === CHAT MESSAGE BUBBLE STYLES === */

/* === ADVANCED CHAT FEATURES STYLES === */
.msg-actions { font-size: 0.75rem; display: flex; gap: 12px; margin-top: 5px; opacity: 0; transition: opacity 0.2s; padding: 0 5px; }
.msg-box:hover .msg-actions { opacity: 1; } /* Action buttons appear on hover! */
.msg-action-btn { color: #888; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 3px; font-weight: 600; }
.msg-action-btn:hover { color: var(--lime-dark); }

.quote-box { font-size: 0.8rem; background: rgba(0,0,0,0.06); padding: 8px 10px; border-left: 3px solid #ccc; border-radius: 6px; margin-bottom: 8px; color: #555; }
.msg-box.me .quote-box { background: rgba(255,255,255,0.2); border-left-color: white; color: #eee; }
.msg-box.me .quote-box strong { color: white !important; }

.reply-preview { display: none; padding: 10px 20px; background: #f1f5f9; border-left: 4px solid var(--lime-primary); justify-content: space-between; align-items: center; border-top: 1px solid #ddd; }
.reply-preview.active { display: flex; }
.edited-tag { font-size: 0.7rem; opacity: 0.7; font-style: italic; margin-left: 5px; }

.msg-box { margin-bottom: 15px; display: flex; flex-direction: column; }
.msg-box.me { align-items: flex-end; }
.msg-box.other { align-items: flex-start; }

.msg-name { font-size: 0.75rem; color: #888; margin-bottom: 3px; font-weight: 700; text-transform: capitalize; }

.msg-bubble { 
    max-width: 80%; 
    padding: 10px 15px; 
    border-radius: 18px; 
    font-size: 0.95rem; 
    line-height: 1.4; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

/* Green bubbles for ME */
.msg-box.me .msg-bubble { 
    background: linear-gradient(135deg, var(--lime-primary) 0%, var(--lime-dark) 100%); 
    color: white; 
    border-bottom-right-radius: 4px; 
}

/* Grey bubbles for OTHERS */
.msg-box.other .msg-bubble { 
    background: #f1f5f9; 
    color: #334155; 
    border-bottom-left-radius: 4px; 
    border: 1px solid #e2e8f0;
}

/* === CHAT PANEL STYLES === */
.chat-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2999; transition: opacity 0.3s ease; }
.chat-overlay.hidden { opacity: 0; pointer-events: none; }

.chat-panel {
    position: fixed;
    top: 0;
    right: -100%; /* Hidden off-screen by default */
    width: 400px;
    height: 100vh;
    background: white;
    box-shadow: -5px 0 25px rgba(0,0,0,0.1);
    z-index: 3000;
    transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
}
.chat-panel.open { right: 0; /* Slides in */ }

@media (max-width: 768px) { .chat-panel { width: 85vw; } } /* Wider on mobile */

.chat-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; display: flex; justify-content: space-between; align-items: center; }
.chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; background: #f8fafc; }
.chat-input-area { padding: 20px; background: white; border-top: 1px solid #eee; display: flex; gap: 10px; }
.chat-input-area input { flex-grow: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
.chat-input-area input:focus { outline: none; border-color: var(--lime-primary); }

/* GLOBAL FONT */
@import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap');
/* NEW FONTS (For Formula Sheet) */
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:wght@600;700&display=swap');

:root {
--lime-primary: #32CD32;
--lime-dark: #228B22;
--lime-light: #F0FFF0;
--glass-bg: rgba(255, 255, 255, 0.95);
--text-dark: #1a1a1a;
--shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
--danger: #dc2626; 
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
font-family: 'Plus Jakarta Sans', sans-serif;
background: linear-gradient(135deg, #f6fff6 0%, #e8f5e9 100%);
color: var(--text-dark);
min-height: 100vh;
}

.container { max-width: 1200px; margin: 0 auto; padding: 20px; }

/* === FORMULA SHEET SPECIFIC STYLES === */
#view-formulae .formula-section, #view-definitions .def-section, #view-tips .formula-section { margin-bottom: 40px; }

#view-formulae .chapter-title, #view-definitions .topic-title, #view-tips .chapter-title {
font-family: 'Playfair Display', serif;
font-size: 1.6rem;
color: #1a1a1a;
margin-bottom: 20px;
border-bottom: 2px solid var(--lime-primary);
padding-bottom: 5px;
display: inline-block;
}

#view-formulae .formula-grid, #view-definitions .def-grid, #view-tips .formula-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
gap: 20px;
}

.formula-card, .def-card {
background: white;
padding: 25px;
border-radius: 12px;
box-shadow: 0 4px 15px rgba(0,0,0,0.03);
border: 1px solid rgba(0,0,0,0.05);
transition: transform 0.2s ease;
position: relative;
overflow: hidden;
}

.formula-card:hover, .def-card:hover {
transform: translateY(-3px);
border-color: var(--lime-primary);
}

.formula-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--lime-primary); }
/* Blue accent for definitions */
.def-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: #3b82f6; }

/* === NEW TIPS STYLES === */
.tip-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.03);
    border: 1px solid rgba(0,0,0,0.05);
    transition: transform 0.2s ease;
    position: relative;
    overflow: hidden;
}
.tip-card:hover {
    transform: translateY(-3px);
    border-color: #FFD700; /* Gold/Yellow Color */
}
.tip-card::before { 
    content: ''; 
    position: absolute; 
    top: 0; 
    left: 0; 
    width: 4px; 
    height: 100%; 
    background: #FFD700; /* Gold/Yellow Strip */
}

.t-topic {
    font-family: 'Inter', sans-serif;
    font-size: 0.85rem;
    font-weight: 700;
    color: #d4ac0d; /* Darker Gold Text */
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}
.t-content {
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 0.95rem;
    color: #444;
    line-height: 1.6;
}
/* Yellow glow for the active lightbulb button */
.nav-btn.active.tip-nav-btn {
    background: #fff9c4; /* Light yellow bg */
    color: #b7950b;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
}

.f-title, .d-term {
font-family: 'Inter', sans-serif;
font-size: 0.85rem;
font-weight: 600;
color: #888;
text-transform: uppercase;
letter-spacing: 0.5px;
margin-bottom: 8px;
}
.d-term { font-size: 1.1rem; color: #1e293b; font-family: 'Playfair Display', serif; font-weight: 700; }

.f-body, .d-desc {
font-family: 'Inter', sans-serif;
font-size: 1.15rem;
font-weight: 500;
color: #2c3e50;
line-height: 1.4;
}
.d-desc { font-size: 0.95rem; font-weight: 400; color: #475569; line-height: 1.6; }

/* === APP STYLES === */
.login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); z-index: 1000; }
.login-card { background: white; padding: 50px; width: 400px; border-radius: 24px; box-shadow: var(--shadow); text-align: center; border: 1px solid var(--lime-light); }
.login-input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 2px solid #eee; font-size: 1rem; transition: 0.3s; }
.login-input:focus { border-color: var(--lime-primary); outline: none; }

.app-header { display: flex; justify-content: space-between; align-items: center; background: var(--glass-bg); padding: 20px 30px; border-radius: 20px; margin-bottom: 30px; border: 1px solid white; box-shadow: var(--shadow); }
.header-left { display: flex; align-items: center; }
.app-logo { height: 45px; width: auto; margin-right: 15px; }

.nav-btn { background: transparent; border: none; font-weight: 700; color: #666; padding: 10px 20px; cursor: pointer; transition: 0.3s; font-size: 1rem; }
.nav-btn.active { color: var(--lime-dark); background: var(--lime-light); border-radius: 10px; }

.series-header { margin: 40px 0 20px 0; border-bottom: 2px solid #eee; padding-bottom: 10px; display: flex; align-items: baseline; gap: 15px; }
.year-big { font-size: 2rem; font-weight: 800; color: #ccc; }
.series-name { font-size: 1.4rem; font-weight: 700; color: var(--lime-dark); }
.papers-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
.paper-card { background: white; padding: 25px; border-radius: 18px; cursor: pointer; transition: 0.3s; border: 2px solid transparent; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
.paper-card:hover { border-color: var(--lime-primary); transform: translateY(-5px); }
.paper-tag { display: inline-block; padding: 5px 10px; background: var(--lime-light); color: var(--lime-dark); border-radius: 8px; font-size: 0.8rem; font-weight: 700; margin-bottom: 10px; }

/* STATS & SCORECARD - RESTORED ORIGINAL */
.stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
.stat-card { background: white; padding: 25px; border-radius: 20px; box-shadow: var(--shadow); border: 1px solid var(--lime-light); text-align: center; transition: transform 0.3s ease; }
.stat-card:hover { transform: translateY(-5px); border-color: var(--lime-primary); }
.stat-value { font-size: 2.5rem; font-weight: 800; color: var(--lime-dark); display: block; margin-bottom: 5px; }
.stat-label { font-size: 0.9rem; color: #888; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

.modern-table { width: 100%; border-collapse: separate; border-spacing: 0 15px; margin-top: 10px; }
.modern-table thead th { color: #888; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; padding: 0 20px 10px 20px; border: none; background: transparent; text-align: left; }
.modern-table tbody tr { background: white; box-shadow: 0 5px 20px rgba(0,0,0,0.03); }
.modern-table td { padding: 20px; border: none; }
.modern-table td:first-child { border-top-left-radius: 15px; border-bottom-left-radius: 15px; }
.modern-table td:last-child { border-top-right-radius: 15px; border-bottom-right-radius: 15px; text-align: right; }
.score-badge { background: var(--lime-light); color: var(--lime-dark); padding: 8px 16px; border-radius: 30px; font-weight: 800; font-size: 1rem; border: 1px solid var(--lime-primary); }
.progress-track { background: #f0f0f0; height: 8px; width: 100px; border-radius: 10px; overflow: hidden; display: inline-block; vertical-align: middle; margin-right: 10px; }
.progress-fill { background: var(--lime-primary); height: 100%; border-radius: 10px; }
.reset-icon-btn { background: #fff0f0; color: #ff4757; border: 1px solid #ff4757; padding: 8px 15px; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.8rem; transition: 0.3s; }
.reset-icon-btn:hover { background: #ff4757; color: white; }

/* WORKSPACE */
.workspace { display: grid; grid-template-columns: 1fr 1.2fr; gap: 30px; height: 85vh; }
.insert-panel { background: #333; border-radius: 20px; overflow: hidden; box-shadow: var(--shadow); height: 100%; position: relative; transition: all 0.3s ease; }
.insert-pdf-frame { width: 100%; height: 100%; border: none; }

/* MAXIMIZE INSERT FEATURE */
.insert-panel.fullscreen {
    position: fixed;
    top: 5vh;
    left: 5vw;
    width: 90vw;
    height: 90vh;
    z-index: 2000;
    box-shadow: 0 0 100px rgba(0,0,0,0.5);
    border: 5px solid white;
}
.maximize-insert-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    z-index: 10;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 8px;
    padding: 8px 15px;
    cursor: pointer;
    font-weight: 700;
    font-size: 0.9rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    transition: 0.2s;
    color: #333;
}
.maximize-insert-btn:hover { background: white; transform: scale(1.05); }


.questions-panel { overflow-y: auto; padding-right: 10px; height: 100%; }
.question-card { background: white; padding: 30px; border-radius: 20px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.02); border: 1px solid #f0f0f0; }
.q-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
.q-badge { background: var(--lime-dark); color: white; padding: 5px 12px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }

textarea { width: 100%; min-height: 200px; padding: 15px; border: 2px solid #eee; border-radius: 12px; margin: 15px 0 5px 0; font-family: inherit; font-size: 1rem; resize: vertical; transition: 0.3s; }
textarea:focus { border-color: var(--lime-primary); outline: none; }

/* EXPAND FEATURE - NEW STYLE */
textarea.expanded {
    min-height: 500px;
    border-color: var(--lime-dark);
    box-shadow: 0 0 15px rgba(50, 205, 50, 0.1);
}
.expand-btn {
    background: #f0f0f0;
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    color: #333;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 5px;
    transition: 0.2s;
    float: right; 
}
.expand-btn:hover {
    background: #e0e0e0;
}

/* WORD COUNT STYLE */
.word-count { font-size: 0.85rem; color: #888; text-align: right; margin-bottom: 15px; font-weight: 600; }
.word-count.bad { color: var(--danger); }
.word-count.good { color: var(--lime-dark); }

.submit-btn { background: linear-gradient(135deg, var(--lime-primary) 0%, var(--lime-dark) 100%); color: white; border: none; padding: 12px 30px; border-radius: 50px; font-weight: 700; cursor: pointer; transition: 0.3s; width: 100%; box-shadow: 0 4px 15px rgba(50, 205, 50, 0.3); font-size: 1rem; }
.submit-btn:disabled { background: #ccc; transform: none; box-shadow: none; }

.feedback-box { margin-top: 20px; background: var(--lime-light); padding: 20px; border-radius: 16px; border: 1px solid var(--lime-primary); }
.model-ans-box { background: #1a1a1a; color: #f0f0f0; padding: 15px; border-radius: 10px; margin-top: 15px; font-size: 0.95rem; line-height: 1.6; white-space: pre-wrap; }

.hidden { display: none !important; }
.toggle-insert { display: none; margin-bottom: 15px; background: #eee; padding: 10px; text-align: center; border-radius: 10px; cursor: pointer; }
@media (max-width: 900px) { .workspace { grid-template-columns: 1fr; height: auto; } .insert-panel { display: none; height: 400px; } .insert-panel.show { display: block; } .toggle-insert { display: block; } }

/* === UNREAD BADGE STYLE === */
.unread-badge {
    position: absolute;
    top: 5px;
    right: 5px;
    width: 12px;
    height: 12px;
    background-color: #ef4444; /* Bright Red */
    border-radius: 50%;
    border: 2px solid white;
}
.unread-badge.hidden {
    display: none;
}

</style>
</head>
<body>

<div id="login-layer" class="login-screen">
    <div class="login-card" style="text-align: left;">
        <img src="logo.png" alt="Logo" style="width: 100%; height: auto; display: block; margin-bottom: 20px;">
        <input type="text" id="u-in" class="login-input" placeholder="username">
        <input type="password" id="p-in" class="login-input" placeholder="******">
        <button class="submit-btn" onclick="tryLogin()">Sign in</button>
    </div>
</div>

<div id="app-layer" class="hidden">
<div class="container">

<div class="app-header">
    <div class="header-left">
        <img src="logo.png" alt="Logo" class="app-logo" onerror="this.style.display='none'">
        <div>
            <h2 style="color:var(--lime-dark); margin:0;">Habibi Studies</h2>
            <div id="welcome-msg" class="welcome-text"></div>
        </div>
    </div>
    <div class="nav">
        <button class="nav-btn active" onclick="setView('papers')">Papers</button>
        <button class="nav-btn" onclick="setView('formulae')">Formulae</button>
        <button class="nav-btn" onclick="setView('definitions')">Definitions</button>
        <button class="nav-btn" onclick="setView('scorecard')">Scorecard</button>
        <button class="nav-btn" onclick="setView('leaderboard')">üèÜ Leaderboard</button>
        <button class="nav-btn" onclick="toggleChat()" style="position: relative; color: #3b82f6; font-weight: 800;">
            <span style="font-size: 1.5rem; vertical-align: middle; margin-right: 5px;">üí¨</span>
            <span id="unread-badge" class="unread-badge hidden"></span>
        </button>
        <button class="nav-btn" onclick="doLogout()">Logout</button>
    </div>
</div>

<div id="view-papers">

    <div class="series-header"><div class="year-big">2024</div><div class="series-name">Feb / March Series</div></div>
    <div class="papers-grid">
        <div class="paper-card" onclick="openPaper('2024_fm_32')"><span class="paper-tag">9609/32</span><h3>Clean Delivery (CD)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
    </div>

    <div class="series-header"><div class="year-big">2024</div><div class="series-name">May / June Series</div></div>
    <div class="papers-grid">
        <div class="paper-card" onclick="openPaper('2024_mj_31')"><span class="paper-tag">9609/31</span><h3>Gordy Building Supplies (GBS)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
        <div class="paper-card" onclick="openPaper('2024_mj_32')"><span class="paper-tag">9609/32</span><h3>Soymai Farms (SF)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
        <div class="paper-card" onclick="openPaper('2024_mj_33')"><span class="paper-tag">9609/33</span><h3>Sunil's Clothing Company (SCC)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
    </div>

    <div class="series-header"><div class="year-big">2024</div><div class="series-name">Oct / Nov Series</div></div>
    <div class="papers-grid">
        <div class="paper-card" onclick="openPaper('2024_on_31')"><span class="paper-tag">9609/31</span><h3>TopoChoc Enterprises (TC)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
        <div class="paper-card" onclick="openPaper('2024_on_32')"><span class="paper-tag">9609/32</span><h3>Habesha Clean Cooking (HCC)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
        <div class="paper-card" onclick="openPaper('2024_on_33')"><span class="paper-tag">9609/33</span><h3>Australasia Fitness Factory (AFF)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
    </div>

    <div class="series-header"><div class="year-big">2025</div><div class="series-name">Feb / March Series</div></div>
    <div class="papers-grid">
        <div class="paper-card" onclick="openPaper('2025_fm_32')"><span class="paper-tag">9609/32</span><h3>Iyipada (IPA)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
    </div>

    <div class="series-header"><div class="year-big">2025</div><div class="series-name">May / June Series</div></div>
    <div class="papers-grid">
        <div class="paper-card" onclick="openPaper('2025_mj_31')"><span class="paper-tag">9609/31</span><h3>Wisdom Shoes (WS)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
        <div class="paper-card" onclick="openPaper('2025_mj_32')"><span class="paper-tag">9609/32</span><h3>Pura AI Robots (PAIR)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
        <div class="paper-card" onclick="openPaper('2025_mj_33')"><span class="paper-tag">9609/33</span><h3>We Care Products (WCP)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
    </div>

    <div class="series-header"><div class="year-big">2025</div><div class="series-name">Oct / Nov Series</div></div>
    <div class="papers-grid">
        <div class="paper-card" onclick="openPaper('2025_on_31')"><span class="paper-tag">9609/31</span><h3>Pedro's Perfect Pies (PPP)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
        <div class="paper-card" onclick="openPaper('2025_on_32')"><span class="paper-tag">9609/32</span><h3>Komate Tropical Juice (KTJ)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
        <div class="paper-card" onclick="openPaper('2025_on_33')"><span class="paper-tag">9609/33</span><h3>Lithium Battery Metals (LBM)</h3><p style="color:#888; margin-top:5px;">Paper 3 ‚Ä¢ PDF Available</p></div>
    </div>
</div>

<div id="view-formulae" class="hidden">
    <div class="formula-section">
        <h3 class="chapter-title">Finance: Profitability & Liquidity Ratios</h3>
        <div class="formula-grid">
            <div class="formula-card"><div class="f-title">Gross Profit</div><div class="f-body">Revenue - Cost of Sales</div></div>
            <div class="formula-card"><div class="f-title">Gross Profit Margin (%)</div><div class="f-body">(Gross Profit / Revenue) √ó 100</div></div>
            <div class="formula-card"><div class="f-title">Operating Profit Margin (%)</div><div class="f-body">(Operating Profit / Revenue) √ó 100</div></div>
            <div class="formula-card"><div class="f-title">ROCE (%)</div><div class="f-body">(Operating Profit / Capital Employed) √ó 100</div></div>
            <div class="formula-card"><div class="f-title">Current Ratio</div><div class="f-body">Current Assets / Current Liabilities</div></div>
            <div class="formula-card"><div class="f-title">Liquid Assets</div><div class="f-body">Current Assets - Inventories</div></div>
            <div class="formula-card"><div class="f-title">Acid Test Ratio</div><div class="f-body">Liquid Assets / Current Liabilities</div></div>
            <div class="formula-card"><div class="f-title">Working Capital</div><div class="f-body">Current Assets - Current Liabilities</div></div>
        </div>
    </div>

    <div class="formula-section">
        <h3 class="chapter-title">Finance: Efficiency Ratios</h3>
        <div class="formula-grid">
            <div class="formula-card"><div class="f-title">Cost of Sales</div><div class="f-body">(Opening Inventories + Purchases) - Closing Inventories</div></div>
            <div class="formula-card"><div class="f-title">Average Inventory</div><div class="f-body">(Inventory Start + Inventory End) / 2</div></div>
            <div class="formula-card"><div class="f-title">Rate of Inventory Turnover</div><div class="f-body">Cost of Sales / Average Inventory</div></div>
            <div class="formula-card"><div class="f-title">Trade Payable Turnover (Days)</div><div class="f-body">(Trade Payables / Credit Purchases) √ó 365</div></div>
        </div>
    </div>

    <div class="formula-section">
        <h3 class="chapter-title">Finance: Shareholder & Gearing Ratios</h3>
        <div class="formula-grid">
            <div class="formula-card"><div class="f-title">Earnings Per Share (EPS)</div><div class="f-body">Profit for Year / Number of Shares Issued</div></div>
            <div class="formula-card"><div class="f-title">Price / Earnings (P/E) Ratio</div><div class="f-body">Market Share Price / Earnings Per Share</div></div>
            <div class="formula-card"><div class="f-title">Dividend Per Share</div><div class="f-body">Total Annual Dividends / Total Issued Shares</div></div>
            <div class="formula-card"><div class="f-title">Dividend Yield Ratio (%)</div><div class="f-body">(Dividend Per Share / Market Share Price) √ó 100</div></div>
            <div class="formula-card"><div class="f-title">Dividend Cover Ratio</div><div class="f-body">Profit for Year / Annual Dividends</div></div>
            <div class="formula-card"><div class="f-title">Gearing Ratio (%)</div><div class="f-body">(Non-Current Liabilities / Capital Employed) √ó 100</div></div>
            <div class="formula-card"><div class="f-title">Reserve</div><div class="f-body">Shareholders' Equity - Equity Capital</div></div>
        </div>
    </div>

    <div class="formula-section">
        <h3 class="chapter-title">Finance: Accounting & Asset Valuation</h3>
        <div class="formula-grid">
            <div class="formula-card"><div class="f-title">Annual Depreciation</div><div class="f-body">(Original Cost - Residual Value) / Useful Life</div></div>
            <div class="formula-card"><div class="f-title">Net Book Value</div><div class="f-body">Original Cost - Accumulated Depreciation</div></div>
            <div class="formula-card"><div class="f-title">Net Realisable Value</div><div class="f-body">Existing Inventory Value - Cost of Selling</div></div>
        </div>
    </div>

    <div class="formula-section">
        <h3 class="chapter-title">Investment Appraisal</h3>
        <div class="formula-grid">
            <div class="formula-card"><div class="f-title">Average Investment</div><div class="f-body">(Initial Capital Cost + Residual Capital Value) / 2</div></div>
            <div class="formula-card"><div class="f-title">ARR (Accounting Rate of Return)</div><div class="f-body">(Average Annual Profit / Average Investment) √ó 100</div></div>
            <div class="formula-card"><div class="f-title">Payback Period</div><div class="f-body">Amount Invested / Annual Net Cash Flow</div></div>
            <div class="formula-card"><div class="f-title">Payback - Additional Months</div><div class="f-body">(Additional Net Cash Flow Needed / Annual Cash Flow) √ó 12</div></div>
        </div>
    </div>

    <div class="formula-section">
        <h3 class="chapter-title">Marketing</h3>
        <div class="formula-grid">
            <div class="formula-card"><div class="f-title">Total Revenue</div><div class="f-body">Selling Price √ó Quantity Sold</div></div>
            <div class="formula-card"><div class="f-title">Market Share (%)</div><div class="f-body">(Sales of Business / Total Market Sales) √ó 100</div></div>
            <div class="formula-card"><div class="f-title">Price Elasticity (PED)</div><div class="f-body">% Change in Quantity Demanded / % Change in Price</div></div>
            <div class="formula-card"><div class="f-title">Income Elasticity (YED)</div><div class="f-body">% Change in Demand / % Change in Income</div></div>
            <div class="formula-card"><div class="f-title">Promotional Elasticity</div><div class="f-body">% Change in Demand / % Change in Promotional Spending</div></div>
        </div>
    </div>

    <div class="formula-section">
        <h3 class="chapter-title">Operations & Project Management</h3>
        <div class="formula-grid">
            <div class="formula-card"><div class="f-title">Capacity Utilisation</div><div class="f-body">(Current Output / Maximum Output) √ó 100</div></div>
            <div class="formula-card"><div class="f-title">Total Float</div><div class="f-body">Latest Finishing Time (LFT) - Duration - Earliest Starting Time (EST)</div></div>
            <div class="formula-card"><div class="f-title">Free Float</div><div class="f-body">EST (Next Activity) - Duration - EST (This Activity)</div></div>
        </div>
    </div>

    <div class="formula-section">
        <h3 class="chapter-title">Human Resources</h3>
        <div class="formula-grid">
            <div class="formula-card"><div class="f-title">Absenteeism Rate (%)</div><div class="f-body">(Number of Days Absent / Total Workdays) √ó 100</div></div>
            <div class="formula-card"><div class="f-title">Labour Turnover</div><div class="f-body">(Number of Staff Leaving / Average Staff) √ó 100</div></div>
        </div>
    </div>
</div>


<div id="view-definitions" class="hidden">
    <div class="def-section">
        <h3 class="topic-title">Strategy & Economics</h3>
        <div class="def-grid">
            <div class="def-card"><div class="d-term">Privatization</div><div class="d-desc">The act of selling state-owned and controlled business organizations to investors in the private sector.</div></div>
            <div class="def-card"><div class="d-term">Nationalization</div><div class="d-desc">The transfer of privately owned businesses to state (government) ownership and control.</div></div>
            <div class="def-card"><div class="d-term">Minimum wage</div><div class="d-desc">Employers are not allowed to pay less than the set minimum wage per hour.</div></div>
            <div class="def-card"><div class="d-term">Monopoly</div><div class="d-desc">A market in which there is only one supplier with no close competitors.</div></div>
            <div class="def-card"><div class="d-term">Collusion</div><div class="d-desc">Businesses agree to work together and restrict competition by fixing prices and sharing contracts between themselves.</div></div>
            <div class="def-card"><div class="d-term">Social audit</div><div class="d-desc">A report on the impact a business has on society.</div></div>
            <div class="def-card"><div class="d-term">Demographic</div><div class="d-desc">Relating to the structure of the population.</div></div>
            <div class="def-card"><div class="d-term">Globalization</div><div class="d-desc">The increasing freedom of movement of goods, capital, and people around the world.</div></div>
            <div class="def-card"><div class="d-term">Information technology (IT)</div><div class="d-desc">The use of electronic technology to gather, store, process and communicate information.</div></div>
            <div class="def-card"><div class="d-term">Protectionism</div><div class="d-desc">The use of barriers to free trade to protect a country's domestic industries.</div></div>
            <div class="def-card"><div class="d-term">Tariff</div><div class="d-desc">A tax imposed on an imported product.</div></div>
            <div class="def-card"><div class="d-term">Quota</div><div class="d-desc">A physical limit placed on the quantity of imports of certain products.</div></div>
            <div class="def-card"><div class="d-term">Voluntary export limits</div><div class="d-desc">Agreed limits to the quantity of certain goods sold by one country to another.</div></div>
            <div class="def-card"><div class="d-term">Free international trade</div><div class="d-desc">Trade with no restrictions or barriers that might prevent or limit trade between countries.</div></div>
            <div class="def-card"><div class="d-term">Environmental audit</div><div class="d-desc">Assesses the impact of the activities and decisions of a business on the environment.</div></div>
            <div class="def-card"><div class="d-term">Sustainability</div><div class="d-desc">Activities that meet the needs of the present without compromising the ability of future generations to meet their needs.</div></div>
            <div class="def-card"><div class="d-term">Green consumerism</div><div class="d-desc">The trend for consumers to only buy products that are produced sustainably without environmental damage.</div></div>
            <div class="def-card"><div class="d-term">External costs</div><div class="d-desc">The costs of an economic activity not paid for by the producer or consumer, but by the rest of society.</div></div>
            <div class="def-card"><div class="d-term">Macroeconomic objectives</div><div class="d-desc">The goals a government aims to achieve for the whole economy.</div></div>
            <div class="def-card"><div class="d-term">Economic growth</div><div class="d-desc">An increase in a country's productive potential, measured by an increase in its real GDP.</div></div>
            <div class="def-card"><div class="d-term">Gross Domestic Product (GDP)</div><div class="d-desc">The total value of goods and services produced in a country in one year.</div></div>
            <div class="def-card"><div class="d-term">Real GDP</div><div class="d-desc">GDP data adjusted for the effects of inflation.</div></div>
            <div class="def-card"><div class="d-term">Inflation</div><div class="d-desc">An increase in the average price level of goods and services, resulting in a fall in the value of money.</div></div>
            <div class="def-card"><div class="d-term">Unemployment</div><div class="d-desc">When members of the working population are willing and able to work but cannot find a job.</div></div>
            <div class="def-card"><div class="d-term">Imports</div><div class="d-desc">Goods and services purchased from other countries.</div></div>
            <div class="def-card"><div class="d-term">Exports</div><div class="d-desc">Goods and services sold to consumers and businesses in other countries.</div></div>
            <div class="def-card"><div class="d-term">Exchange rate</div><div class="d-desc">The price of one currency in terms of another.</div></div>
            <div class="def-card"><div class="d-term">Recession</div><div class="d-desc">A decline in real GDP over two or more consecutive quarters (at least six months).</div></div>
            <div class="def-card"><div class="d-term">Business investment</div><div class="d-desc">Expenditure by businesses on capital equipment, new technology, and research and development.</div></div>
            <div class="def-card"><div class="d-term">Labour productivity</div><div class="d-desc">Average output per employee over a given time period.</div></div>
            <div class="def-card"><div class="d-term">Business cycle</div><div class="d-desc">Regular swings in output, measured by real GDP, from boom conditions to recession.</div></div>
            <div class="def-card"><div class="d-term">Deflation</div><div class="d-desc">A fall in the average price level of goods and services.</div></div>
            <div class="def-card"><div class="d-term">Hyperinflation</div><div class="d-desc">Extremely high and accelerating inflation, eroding the value of the local currency.</div></div>
            <div class="def-card"><div class="d-term">Working population</div><div class="d-desc">Those of working age willing and able to work.</div></div>
            <div class="def-card"><div class="d-term">Cyclical unemployment</div><div class="d-desc">Unemployment caused by low demand during slow economic growth or a recession.</div></div>
            <div class="def-card"><div class="d-term">Structural unemployment</div><div class="d-desc">Unemployment caused by the decline of important industries, leading to job losses in specific sectors.</div></div>
            <div class="def-card"><div class="d-term">Frictional unemployment</div><div class="d-desc">Unemployment caused by workers taking time to find new jobs after leaving or losing their previous jobs.</div></div>
            <div class="def-card"><div class="d-term">Monetary policy</div><div class="d-desc">Decisions about interest rates and the money supply in the economy.</div></div>
            <div class="def-card"><div class="d-term">Fiscal policy</div><div class="d-desc">Decisions about government expenditure, tax rates, and borrowing.</div></div>
            <div class="def-card"><div class="d-term">Budget deficit</div><div class="d-desc">When government spending exceeds revenue from taxation.</div></div>
            <div class="def-card"><div class="d-term">Budget surplus</div><div class="d-desc">When taxation revenue exceeds government spending.</div></div>
            <div class="def-card"><div class="d-term">Supply-side policies</div><div class="d-desc">Government measures to improve market and economic competitiveness.</div></div>
            <div class="def-card"><div class="d-term">Exchange rate depreciation</div><div class="d-desc">A fall in a currency's external value compared to other currencies.</div></div>
            <div class="def-card"><div class="d-term">Exchange rate appreciation</div><div class="d-desc">A rise in a currency's external value compared to other currencies.</div></div>
            <div class="def-card"><div class="d-term">Common currency</div><div class="d-desc">A currency used by multiple countries.</div></div>
            <div class="def-card"><div class="d-term">Eurozone</div><div class="d-desc">European Union countries that use the euro as their currency.</div></div>
            <div class="def-card"><div class="d-term">Strategic management</div><div class="d-desc">Analysis of the current business situation, setting long-term objectives, deciding on business strategies to achieve them, and implementing these strategies.</div></div>
            <div class="def-card"><div class="d-term">Strategic analysis</div><div class="d-desc">Researching the business environment and the business itself to identify future strategies.</div></div>
            <div class="def-card"><div class="d-term">Strategic choice</div><div class="d-desc">The process of selecting a strategy from various alternatives and using techniques to assist decision-making.</div></div>
            <div class="def-card"><div class="d-term">Strategic implementation</div><div class="d-desc">Planning, allocating, and controlling resources to support the chosen strategy.</div></div>
            <div class="def-card"><div class="d-term">Blue ocean strategy</div><div class="d-desc">Exploiting uncontested market space through product differentiation and low cost.</div></div>
            <div class="def-card"><div class="d-term">Red ocean strategy</div><div class="d-desc">Competing with rivals in existing markets.</div></div>
            <div class="def-card"><div class="d-term">SWOT analysis</div><div class="d-desc">Strategic analysis identifying internal strengths and weaknesses, and external opportunities and threats influencing business success.</div></div>
            <div class="def-card"><div class="d-term">Scenario planning</div><div class="d-desc">Identifying potential future situations and preparing business responses.</div></div>
            <div class="def-card"><div class="d-term">PEST analysis</div><div class="d-desc">Strategic analysis of a firm's macro environment, focusing on political, economic, social, and technological factors.</div></div>
            <div class="def-card"><div class="d-term">Porter's five forces model</div><div class="d-desc">Technique for analysing competitive forces within an industry.</div></div>
            <div class="def-card"><div class="d-term">Core competence</div><div class="d-desc">An essential business capability that provides a competitive advantage.</div></div>
            <div class="def-card"><div class="d-term">Core product</div><div class="d-desc">A product based on a business's core competencies, not necessarily for the final consumer or end user.</div></div>
            <div class="def-card"><div class="d-term">Ansoff matrix</div><div class="d-desc">A model illustrating the degree of risk in growth strategies: market penetration, market development, product development, and diversification.</div></div>
            <div class="def-card"><div class="d-term">Market penetration</div><div class="d-desc">Increasing market share in existing markets with existing products.</div></div>
            <div class="def-card"><div class="d-term">Product development</div><div class="d-desc">Developing and selling new or improved products in existing markets.</div></div>
            <div class="def-card"><div class="d-term">Market development</div><div class="d-desc">Selling existing products in new markets.</div></div>
            <div class="def-card"><div class="d-term">Diversification</div><div class="d-desc">Selling different, unrelated goods or services in new markets.</div></div>
            <div class="def-card"><div class="d-term">Force-field analysis</div><div class="d-desc">Identifying and analysing positive factors (driving forces) and negative factors (restraining forces) affecting a decision.</div></div>
            <div class="def-card"><div class="d-term">Decision tree</div><div class="d-desc">A diagram outlining decision options, outcomes, and potential economic returns.</div></div>
            <div class="def-card"><div class="d-term">Expected value</div><div class="d-desc">The probable financial result of an outcome, calculated by multiplying the probability of an event by its forecasted economic return.</div></div>
            <div class="def-card"><div class="d-term">Corporate plan</div><div class="d-desc">A plan detailing a business's central objectives and the strategies to achieve them.</div></div>
            <div class="def-card"><div class="d-term">Corporate planning</div><div class="d-desc">The process used by companies to set long-term plans to meet objectives such as growth and higher returns on capital.</div></div>
            <div class="def-card"><div class="d-term">Corporate culture</div><div class="d-desc">The values, attitudes, and beliefs of an organisation's people that influence internal and external interactions.</div></div>
            <div class="def-card"><div class="d-term">Power culture</div><div class="d-desc">A culture concentrating power among a few individuals.</div></div>
            <div class="def-card"><div class="d-term">Role culture</div><div class="d-desc">A culture where each staff member has a clearly defined job title and role.</div></div>
            <div class="def-card"><div class="d-term">Task culture</div><div class="d-desc">A culture emphasizing cooperation and teamwork.</div></div>
            <div class="def-card"><div class="d-term">Person culture</div><div class="d-desc">A culture giving individuals freedom to express themselves and make their own decisions.</div></div>
            <div class="def-card"><div class="d-term">Entrepreneurial culture</div><div class="d-desc">A culture encouraging risk-taking, innovation, and testing new ventures.</div></div>
            <div class="def-card"><div class="d-term">Change management</div><div class="d-desc">Planning, implementing, controlling, and reviewing the transition of an organisation from its current state to a new one.</div></div>
            <div class="def-card"><div class="d-term">Business process re-engineering</div><div class="d-desc">Rethinking and redesigning business processes to achieve significant performance improvements.</div></div>
            <div class="def-card"><div class="d-term">Project champion</div><div class="d-desc">An individual supporting a project, driving it forward by explaining its benefits, and assisting the team in implementing changes.</div></div>
            <div class="def-card"><div class="d-term">Project groups</div><div class="d-desc">Teams formed within an organisation to solve problems requiring input from various specialists.</div></div>
            <div class="def-card"><div class="d-term">Continuity planning</div><div class="d-desc">Preparing resources to ensure the business can continue operations after a major crisis.</div></div>
        </div>
    </div>

    <div class="def-section">
        <h3 class="topic-title">HR & Leadership</h3>
        <div class="def-grid">
            <div class="def-card"><div class="d-term">Job enrichment</div><div class="d-desc">Aims to use the full capabilities of workers by giving them the opportunity to do more challenging and fulfilling work.</div></div>
            <div class="def-card"><div class="d-term">Functional structure</div><div class="d-desc">Departments are organised by specialist areas such as marketing, finance, human resources, or operations.</div></div>
            <div class="def-card"><div class="d-term">Functional manager</div><div class="d-desc">A senior employee with authority over a complete organisational unit.</div></div>
            <div class="def-card"><div class="d-term">Hierarchical structure</div><div class="d-desc">A structure with multiple levels, where all members except one are subordinate to someone else.</div></div>
            <div class="def-card"><div class="d-term">Level of hierarchy</div><div class="d-desc">A stage in the organisational structure where all personnel share equal status and authority.</div></div>
            <div class="def-card"><div class="d-term">Span of control</div><div class="d-desc">The number of subordinates directly accountable to a manager.</div></div>
            <div class="def-card"><div class="d-term">Divisional organisational structure</div><div class="d-desc">Organises business activities around geographical areas or product groups.</div></div>
            <div class="def-card"><div class="d-term">Delayering</div><div class="d-desc">Removing one or more levels of hierarchy from the organisational structure.</div></div>
            <div class="def-card"><div class="d-term">Matrix structure</div><div class="d-desc">An organisational structure that creates project teams cutting across traditional functional departments.</div></div>
            <div class="def-card"><div class="d-term">Delegation</div><div class="d-desc">Passing authority down the organisational hierarchy.</div></div>
            <div class="def-card"><div class="d-term">Accountability</div><div class="d-desc">The responsibility to account for, explain, and disclose the results of one's work honestly.</div></div>
            <div class="def-card"><div class="d-term">Control</div><div class="d-desc">Measuring and supervising employee performance.</div></div>
            <div class="def-card"><div class="d-term">Authority</div><div class="d-desc">The power to give orders and make decisions.</div></div>
            <div class="def-card"><div class="d-term">Centralisation</div><div class="d-desc">Concentrating important decision-making powers within the head office or organisational centre.</div></div>
            <div class="def-card"><div class="d-term">Decentralisation</div><div class="d-desc">Distributing decision-making powers down the hierarchy to empower subordinates or area/product managers.</div></div>
            <div class="def-card"><div class="d-term">Line managers</div><div class="d-desc">Managers with direct authority over people, decisions, and resources in the organisational hierarchy.</div></div>
            <div class="def-card"><div class="d-term">Staff managers</div><div class="d-desc">Specialists who provide support, information, and assistance to senior line managers.</div></div>
            <div class="def-card"><div class="d-term">Effective communication</div><div class="d-desc">The exchange of information between people or groups, with feedback.</div></div>
            <div class="def-card"><div class="d-term">Communication methods</div><div class="d-desc">The media used to communicate messages.</div></div>
            <div class="def-card"><div class="d-term">Visual communication</div><div class="d-desc">Conveying information or ideas in forms that can be seen.</div></div>
            <div class="def-card"><div class="d-term">Written communication</div><div class="d-desc">Any type of message that uses written words.</div></div>
            <div class="def-card"><div class="d-term">Electronic communication</div><div class="d-desc">Sending messages using media such as computers, email, or video conferencing.</div></div>
            <div class="def-card"><div class="d-term">Information overload</div><div class="d-desc">Receiving too much information, making it difficult to identify and act upon important messages.</div></div>
            <div class="def-card"><div class="d-term">Spoken communication</div><div class="d-desc">Sending messages verbally between two or more people.</div></div>
            <div class="def-card"><div class="d-term">Formal communication channels</div><div class="d-desc">The official communication networks and routes used within an organisation.</div></div>
            <div class="def-card"><div class="d-term">One-way communication</div><div class="d-desc">Messages sent in one direction, from sender to receiver, with no feedback expected.</div></div>
            <div class="def-card"><div class="d-term">Two-way communication</div><div class="d-desc">Communication involving message transmission that encourages response and feedback.</div></div>
            <div class="def-card"><div class="d-term">Vertical communication</div><div class="d-desc">Communication between people at different levels in a hierarchy.</div></div>
            <div class="def-card"><div class="d-term">Horizontal communication</div><div class="d-desc">Communication between people on the same level of hierarchy.</div></div>
            <div class="def-card"><div class="d-term">Communication barriers</div><div class="d-desc">Reasons why communication fails.</div></div>
            <div class="def-card"><div class="d-term">Informal communication</div><div class="d-desc">Unofficial communication channels that exist between informal groups within an organisation.</div></div>
            <div class="def-card"><div class="d-term">Leadership</div><div class="d-desc">The art of motivating a group of people to achieve a common objective.</div></div>
            <div class="def-card"><div class="d-term">Informal leader</div><div class="d-desc">A person without formal authority but who has the respect of colleagues and some power over them.</div></div>
            <div class="def-card"><div class="d-term">Emotional intelligence (EI)</div><div class="d-desc">The ability to understand and manage one's own emotions and those of others to improve business performance.</div></div>
            <div class="def-card"><div class="d-term">Emotional quotient (EQ)</div><div class="d-desc">The measurement of a person's emotional intelligence as assessed through a standardized test.</div></div>
            <div class="def-card"><div class="d-term">Human resource management (HRM) strategy</div><div class="d-desc">A long-term plan for managing an organisation's human resources.</div></div>
            <div class="def-card"><div class="d-term">Hard HRM</div><div class="d-desc">An approach to managing employees focused on cutting costs.</div></div>
            <div class="def-card"><div class="d-term">Soft HRM</div><div class="d-desc">An approach to managing employees focused on their development, self-fulfillment, and motivation.</div></div>
            <div class="def-card"><div class="d-term">Full-time employment contract</div><div class="d-desc">A contract for a complete working week.</div></div>
            <div class="def-card"><div class="d-term">Permanent employment contract</div><div class="d-desc">A contract where the worker is employed indefinitely unless dismissed, made redundant, or they decide to leave.</div></div>
            <div class="def-card"><div class="d-term">Temporary contract</div><div class="d-desc">A contract offered for a fixed period, such as six months, with no obligation for renewal.</div></div>
            <div class="def-card"><div class="d-term">Part-time contract</div><div class="d-desc">A contract where workers are only required to work a certain number of hours each week (less than full-time).</div></div>
            <div class="def-card"><div class="d-term">Zero-hours contract</div><div class="d-desc">A contract with no guaranteed minimum hours per week, requiring availability when called by the employer.</div></div>
            <div class="def-card"><div class="d-term">Gig economy</div><div class="d-desc">A labor market with temporary, flexible jobs, where workers are often independent contractors or freelancers.</div></div>
            <div class="def-card"><div class="d-term">Compressed working hours</div><div class="d-desc">A full-time workweek completed in fewer days, such as four 10-hour workdays.</div></div>
            <div class="def-card"><div class="d-term">Shift work</div><div class="d-desc">Work scheduled outside the traditional 9 a.m. to 5 p.m., including evening, night, early morning, or rotating shifts.</div></div>
            <div class="def-card"><div class="d-term">Absenteeism</div><div class="d-desc">The rate of workforce absence as a proportion of the total number of employees.</div></div>
            <div class="def-card"><div class="d-term">Management by objectives (MBO)</div><div class="d-desc">A system comparing actual performance and achievements against pre-set objectives for each department or employee.</div></div>
            <div class="def-card"><div class="d-term">Transformational leadership</div><div class="d-desc">A leadership style where the leader works with teams to identify the need for change, create a vision, and implement change collaboratively.</div></div>
        </div>
    </div>

    <div class="def-section">
        <h3 class="topic-title">Marketing</h3>
        <div class="def-grid">
            <div class="def-card"><div class="d-term">Price elasticity of demand (PED)</div><div class="d-desc">A measure of how demand for a product changes in response to a change in its price.</div></div>
            <div class="def-card"><div class="d-term">Income elasticity of demand</div><div class="d-desc">A measure of how demand for a product changes in response to changes in consumer incomes.</div></div>
            <div class="def-card"><div class="d-term">Inferior good</div><div class="d-desc">A product whose demand increases when consumer incomes fall.</div></div>
            <div class="def-card"><div class="d-term">New product development (NPD)</div><div class="d-desc">The design, creation, and marketing of new goods and services.</div></div>
            <div class="def-card"><div class="d-term">Research and development (R&D)</div><div class="d-desc">Scientific research and technical development of new products and processes.</div></div>
            <div class="def-card"><div class="d-term">Test marketing</div><div class="d-desc">Launching a product on a small-scale market to test consumer reactions.</div></div>
            <div class="def-card"><div class="d-term">Sales forecasting</div><div class="d-desc">Predicting future sales levels and trends.</div></div>
            <div class="def-card"><div class="d-term">Trend</div><div class="d-desc">The underlying movement in data over time.</div></div>
            <div class="def-card"><div class="d-term">Seasonal fluctuations</div><div class="d-desc">Regular, repeated variations in sales data within a 12-month period.</div></div>
            <div class="def-card"><div class="d-term">Cyclical fluctuations</div><div class="d-desc">Variations in sales over longer periods, influenced by the business cycle.</div></div>
            <div class="def-card"><div class="d-term">Random fluctuations</div><div class="d-desc">Unpredictable variations in sales due to unexpected events, such as poor weather or a negative public image.</div></div>
            <div class="def-card"><div class="d-term">Qualitative sales forecasting</div><div class="d-desc">Sales predictions based on expert judgment rather than numerical analysis.</div></div>
            <div class="def-card"><div class="d-term">Sales force composite</div><div class="d-desc">A forecasting method combining individual sales predictions from all sales representatives in a business.</div></div>
            <div class="def-card"><div class="d-term">Delphi method</div><div class="d-desc">A long-range qualitative forecasting technique that gathers forecasts from a panel of experts.</div></div>
            <div class="def-card"><div class="d-term">Jury of experts</div><div class="d-desc">A forecasting method that relies on the expertise of specialists within a business to predict the future.</div></div>
            <div class="def-card"><div class="d-term">Marketing plan</div><div class="d-desc">A detailed and researched report outlining marketing objectives and the strategy to achieve them.</div></div>
            <div class="def-card"><div class="d-term">Economic collaboration</div><div class="d-desc">Countries working together to achieve common goals, such as promoting free international trade.</div></div>
            <div class="def-card"><div class="d-term">Free-trade agreements</div><div class="d-desc">Agreements between countries or trading blocs to reduce or eliminate trade barriers like tariffs and quotas.</div></div>
            <div class="def-card"><div class="d-term">International marketing</div><div class="d-desc">Selling products in markets outside the original domestic market.</div></div>
            <div class="def-card"><div class="d-term">BRICS</div><div class="d-desc">Acronym for five rapidly developing economies with significant market opportunities: Brazil, Russia, India, China, and South Africa.</div></div>
            <div class="def-card"><div class="d-term">Pan-global marketing</div><div class="d-desc">Marketing a standardised product worldwide as if the entire world were a single market, using the same strategies everywhere.</div></div>
            <div class="def-card"><div class="d-term">Global localisation</div><div class="d-desc">Adjusting the marketing mix, including product differentiation, to suit local and regional tastes and cultures while maintaining local market differences.</div></div>
        </div>
    </div>

    <div class="def-section">
        <h3 class="topic-title">Operations</h3>
        <div class="def-grid">
            <div class="def-card"><div class="d-term">Optimal location</div><div class="d-desc">A business location that offers the best combination of quantitative and qualitative factors.</div></div>
            <div class="def-card"><div class="d-term">Quantitative factors</div><div class="d-desc">Measurable issues in financial or numerical terms that managers consider in decision-making.</div></div>
            <div class="def-card"><div class="d-term">Qualitative factors</div><div class="d-desc">Non-measurable issues that managers consider, such as employee satisfaction or brand image.</div></div>
            <div class="def-card"><div class="d-term">Offshoring</div><div class="d-desc">Relocating a business process from one country to another.</div></div>
            <div class="def-card"><div class="d-term">Trade barriers</div><div class="d-desc">Taxes (tariffs) or other restrictions on the free international movement of goods and services.</div></div>
            <div class="def-card"><div class="d-term">Reshoring</div><div class="d-desc">Moving a previously offshored business operation back to its original country.</div></div>
            <div class="def-card"><div class="d-term">Scale of operations</div><div class="d-desc">The maximum output achievable with the available resources.</div></div>
            <div class="def-card"><div class="d-term">Internal economies of scale</div><div class="d-desc">Cost reductions per unit of production achieved as a business expands its operations.</div></div>
            <div class="def-card"><div class="d-term">Internal diseconomies of scale</div><div class="d-desc">Increases in unit production costs that occur when a business grows too large.</div></div>
            <div class="def-card"><div class="d-term">Demerger</div><div class="d-desc">Separating one business unit from another, often reversing a prior merger.</div></div>
            <div class="def-card"><div class="d-term">External economies of scale</div><div class="d-desc">Cost reductions per unit that benefit a business as the industry grows in a region.</div></div>
            <div class="def-card"><div class="d-term">External diseconomies of scale</div><div class="d-desc">Increases in unit costs resulting from industry expansion, particularly in one region.</div></div>
            <div class="def-card"><div class="d-term">Quality product</div><div class="d-desc">A good or service that meets customers' expectations and fulfils its intended purpose.</div></div>
            <div class="def-card"><div class="d-term">Quality standards</div><div class="d-desc">Minimum acceptable production or service standards based on customer expectations.</div></div>
            <div class="def-card"><div class="d-term">Quality control</div><div class="d-desc">Inspecting the product or a sample of products to check for defects.</div></div>
            <div class="def-card"><div class="d-term">Quality assurance</div><div class="d-desc">Ensuring agreed quality standards are met at each production stage to satisfy customers.</div></div>
            <div class="def-card"><div class="d-term">ISO 9000</div><div class="d-desc">An internationally recognised standard for quality assurance methods meeting specific criteria.</div></div>
            <div class="def-card"><div class="d-term">Total Quality Management (TQM)</div><div class="d-desc">A quality approach involving all employees in continuous improvement.</div></div>
            <div class="def-card"><div class="d-term">Internal customers</div><div class="d-desc">People within the organisation relying on the quality of others' work.</div></div>
            <div class="def-card"><div class="d-term">Zero defects</div><div class="d-desc">A mindset focused on ensuring products consistently meet customer expectations.</div></div>
            <div class="def-card"><div class="d-term">Benchmarking</div><div class="d-desc">Comparing a business's performance against the best companies in the same industry.</div></div>
            <div class="def-card"><div class="d-term">Benchmark performance indicators (BPI)</div><div class="d-desc">Key areas of business performance measured and compared with competitors.</div></div>
            <div class="def-card"><div class="d-term">Lean production</div><div class="d-desc">Producing goods and services with minimal wasted resources while maintaining high quality.</div></div>
            <div class="def-card"><div class="d-term">Computer-aided design (CAD)</div><div class="d-desc">Using computer programs to create 2D or 3D graphical representations of physical objects.</div></div>
            <div class="def-card"><div class="d-term">Computer-aided manufacturing (CAM)</div><div class="d-desc">Using computer software to control machine tools and equipment in manufacturing.</div></div>
            <div class="def-card"><div class="d-term">Operational flexibility</div><div class="d-desc">The ability to adjust production levels and product range based on changes in customer demand.</div></div>
            <div class="def-card"><div class="d-term">Process innovation</div><div class="d-desc">Using new or significantly improved production or service delivery methods.</div></div>
            <div class="def-card"><div class="d-term">Enterprise resource planning (ERP)</div><div class="d-desc">Using a single computer application to manage the purchase and use of resources to improve operational efficiency.</div></div>
            <div class="def-card"><div class="d-term">Kaizen</div><div class="d-desc">A Japanese term meaning continuous improvement.</div></div>
            <div class="def-card"><div class="d-term">Cell production</div><div class="d-desc">Flow production organized into self-contained groups responsible for completing a unit of work.</div></div>
            <div class="def-card"><div class="d-term">Critical path analysis (CPA)</div><div class="d-desc">A planning technique that identifies tasks, sequences them, and identifies the critical path.</div></div>
            <div class="def-card"><div class="d-term">Network diagram</div><div class="d-desc">A diagram used in CPA to show the logical sequence and dependencies of activities.</div></div>
            <div class="def-card"><div class="d-term">Critical path</div><div class="d-desc">The sequence of tasks that must be completed on time to ensure the entire project finishes by the agreed date.</div></div>
            <div class="def-card"><div class="d-term">Earliest start time</div><div class="d-desc">The earliest time an activity can begin.</div></div>
            <div class="def-card"><div class="d-term">Latest finish time</div><div class="d-desc">The latest time an activity can finish without delaying the project.</div></div>
            <div class="def-card"><div class="d-term">Total float</div><div class="d-desc">The amount of time an activity can be delayed without delaying the overall project.</div></div>
            <div class="def-card"><div class="d-term">Free float</div><div class="d-desc">The amount of time an activity can be delayed without affecting the start of the following activities.</div></div>
            <div class="def-card"><div class="d-term">Dummy activities</div><div class="d-desc">Used in network diagrams to show logical dependencies between tasks, without consuming time or resources.</div></div>
        </div>
    </div>

    <div class="def-section">
        <h3 class="topic-title">Finance</h3>
        <div class="def-grid">
            <div class="def-card"><div class="d-term">Statement of profit or loss</div><div class="d-desc">A statement that records revenue, costs, and profit (or loss) over a specific period.</div></div>
            <div class="def-card"><div class="d-term">Statement of financial position</div><div class="d-desc">A statement that records a business's assets, liabilities, and shareholders' equity at a particular point in time.</div></div>
            <div class="def-card"><div class="d-term">Asset</div><div class="d-desc">An item of monetary value owned by a business.</div></div>
            <div class="def-card"><div class="d-term">Liability</div><div class="d-desc">A financial obligation that a business must pay in the future.</div></div>
            <div class="def-card"><div class="d-term">Gross profit</div><div class="d-desc">Revenue minus the cost of sales.</div></div>
            <div class="def-card"><div class="d-term">Cost of sales</div><div class="d-desc">The direct cost of the goods sold during a financial period.</div></div>
            <div class="def-card"><div class="d-term">Profit from operations</div><div class="d-desc">Gross profit minus overhead expenses (operating profit).</div></div>
            <div class="def-card"><div class="d-term">Expenses</div><div class="d-desc">Overhead costs in operating the business, deducted from gross profit to calculate profit from operations.</div></div>
            <div class="def-card"><div class="d-term">Profit before tax</div><div class="d-desc">Profit from operations minus interest costs.</div></div>
            <div class="def-card"><div class="d-term">Profit for the year (profit after tax)</div><div class="d-desc">Profit before tax minus corporation tax.</div></div>
            <div class="def-card"><div class="d-term">Dividends</div><div class="d-desc">A portion of profits paid to shareholders as a return on investment.</div></div>
            <div class="def-card"><div class="d-term">Low-quality profit</div><div class="d-desc">One-off profits that are not easily repeated or sustained.</div></div>
            <div class="def-card"><div class="d-term">High-quality profit</div><div class="d-desc">Profits that can be repeated and sustained.</div></div>
            <div class="def-card"><div class="d-term">Shareholders' equity</div><div class="d-desc">The total value of assets minus the total value of liabilities.</div></div>
            <div class="def-card"><div class="d-term">Share capital</div><div class="d-desc">The total value of capital raised from shareholders through the issuance of shares.</div></div>
            <div class="def-card"><div class="d-term">Goodwill</div><div class="d-desc">The value arising when a business is bought for more than the balance sheet value of its assets.</div></div>
            <div class="def-card"><div class="d-term">Window dressing</div><div class="d-desc">Techniques used by companies to manipulate financial statements to show more favorable results.</div></div>
            <div class="def-card"><div class="d-term">Net current assets</div><div class="d-desc">The capital required for day-to-day activities, also called working capital (current assets minus current liabilities).</div></div>
            <div class="def-card"><div class="d-term">Reserves</div><div class="d-desc">Accumulated retained profits and capital reserves from the revaluation of non-current assets.</div></div>
            <div class="def-card"><div class="d-term">Net realisable value (NRV)</div><div class="d-desc">The amount for which inventory can be sold, minus the cost of selling it.</div></div>
            <div class="def-card"><div class="d-term">Depreciation</div><div class="d-desc">The reduction in the estimated value of a non-current asset over time.</div></div>
            <div class="def-card"><div class="d-term">Net book value</div><div class="d-desc">The current statement of financial position value of a non-current asset (original cost minus accumulated depreciation).</div></div>
            <div class="def-card"><div class="d-term">Straight-line depreciation</div><div class="d-desc">A fixed amount of depreciation subtracted from the asset's value each year.</div></div>
            <div class="def-card"><div class="d-term">Current ratio</div><div class="d-desc">A ratio comparing current assets with current liabilities.</div></div>
            <div class="def-card"><div class="d-term">Acid test ratio</div><div class="d-desc">A ratio comparing liquid assets with current liabilities.</div></div>
            <div class="def-card"><div class="d-term">Profitability</div><div class="d-desc">A measure of a business's ability to make a profit from sales or capital investment.</div></div>
            <div class="def-card"><div class="d-term">Gross profit margin ratio</div><div class="d-desc">A ratio comparing gross profit (before overhead expenses) with revenue.</div></div>
            <div class="def-card"><div class="d-term">Operating profit margin</div><div class="d-desc">A ratio comparing operating profit for the year with revenue.</div></div>
            <div class="def-card"><div class="d-term">Return on capital employed (ROCE) ratio</div><div class="d-desc">A ratio comparing operating profit (profit from operations) with the capital employed in the business.</div></div>
            <div class="def-card"><div class="d-term">Capital employed</div><div class="d-desc">The total value of long-term finance invested in a business.</div></div>
            <div class="def-card"><div class="d-term">Rate of inventory turnover</div><div class="d-desc">The number of times inventory is bought and sold within a year.</div></div>
            <div class="def-card"><div class="d-term">Trade receivables turnover (days)</div><div class="d-desc">The average time (in days) to receive payment from customers who bought on credit.</div></div>
            <div class="def-card"><div class="d-term">Trade payables turnover (days)</div><div class="d-desc">The average time (in days) to pay suppliers for credit purchases.</div></div>
            <div class="def-card"><div class="d-term">Credit purchases</div><div class="d-desc">The value of materials and supplies bought on credit (over one year).</div></div>
            <div class="def-card"><div class="d-term">Gearing ratio</div><div class="d-desc">A ratio that measures the proportion of capital employed that is financed by long-term borrowing (non-current liabilities).</div></div>
            <div class="def-card"><div class="d-term">Share price</div><div class="d-desc">The quoted price of one share on the stock exchange.</div></div>
            <div class="def-card"><div class="d-term">Dividend</div><div class="d-desc">The share of company profits paid to shareholders.</div></div>
            <div class="def-card"><div class="d-term">Dividend yield ratio</div><div class="d-desc">A ratio measuring the annual return from dividends as a percentage of the current market share price.</div></div>
            <div class="def-card"><div class="d-term">Dividend per share</div><div class="d-desc">The financial amount received in dividends on one share.</div></div>
            <div class="def-card"><div class="d-term">Dividend cover ratio</div><div class="d-desc">A ratio measuring how many times dividends could be paid from profit for the year.</div></div>
            <div class="def-card"><div class="d-term">Price/earnings ratio</div><div class="d-desc">The number of years it would take, at the current earnings per share, to purchase one share at the current market price.</div></div>
            <div class="def-card"><div class="d-term">Earnings per share</div><div class="d-desc">The amount of profit after tax and interest earned per share.</div></div>
            <div class="def-card"><div class="d-term">Investment appraisal</div><div class="d-desc">Evaluating the profitability or feasibility of an investment project.</div></div>
            <div class="def-card"><div class="d-term">Net present value (NPV)</div><div class="d-desc">The current value of estimated cash flows resulting from an investment.</div></div>
            <div class="def-card"><div class="d-term">Forecasted net cash flow</div><div class="d-desc">Forecast cash inflows minus forecast cash outflows.</div></div>
            <div class="def-card"><div class="d-term">Payback period</div><div class="d-desc">The length of time it takes for net cash inflows to recover the original capital cost of the investment.</div></div>
            <div class="def-card"><div class="d-term">Accounting rate of return (ARR)</div><div class="d-desc">A measure of the annual profitability of an investment as a percentage of the average investment (average capital cost).</div></div>
            <div class="def-card"><div class="d-term">Criterion rate</div><div class="d-desc">The minimum accounting rate of return that a business would accept before approving an investment.</div></div>
            <div class="def-card"><div class="d-term">Discounted cash flow</div><div class="d-desc">The present-day value of a future cash flow.</div></div>
        </div>
    </div>
</div>

<div id="view-tips" class="hidden">
    <div style="text-align:center; margin-bottom:40px;">
        <h2 style="font-size:2rem; color:#b7950b; font-family:'Playfair Display', serif;">üí° Examiner's Tips</h2>
        <p style="color:#888;">Key advice for A Level Business (Chapters 6-36)</p>
    </div>

    <div class="formula-section">
        <h3 class="chapter-title" style="border-color:#FFD700;">External Influences & Economy</h3>
        <div class="formula-grid">
            <div class="tip-card"><div class="t-topic">Employment Laws</div><div class="t-content">You do not need to know specific laws, but know the <strong>main employment laws</strong> in your country and what they expect employers to do.</div></div>
            <div class="tip-card"><div class="t-topic">Consumer Protection</div><div class="t-content">You do not need specific details, but you may be asked how a business is affected by consumer protection laws in your country.</div></div>
            <div class="tip-card"><div class="t-topic">Social Change</div><div class="t-content">Changing social conditions and employment patterns create just as many opportunities as potential risks. Use this to <strong>evaluate</strong> the impact.</div></div>
            <div class="tip-card"><div class="t-topic">Technology Choice</div><div class="t-content">Do not assume a business must always use the latest technology. There are substantial costs, and some businesses thrive without it.</div></div>
            <div class="tip-card"><div class="t-topic">Evaluating Technology</div><div class="t-content">New technology is not the best solution to all problems and introducing it badly can create more problems than it solves.</div></div>
            <div class="tip-card"><div class="t-topic">Defining Multinationals</div><div class="t-content">When defining a multinational business, it is not enough to state that such businesses 'sell products in more than one country'.</div></div>
            <div class="tip-card"><div class="t-topic">Local Context</div><div class="t-content">In case study questions on multinational business activity, you may have the opportunity to use examples from your own country.</div></div>
            <div class="tip-card"><div class="t-topic">Record Keeping</div><div class="t-content">Start keeping your own file of newspaper or website articles on economic events and data, and how businesses are responding.</div></div>
            <div class="tip-card"><div class="t-topic">Growth Evaluation</div><div class="t-content">When evaluating economic growth as an objective, remember that rapid growth is not always beneficial (e.g., pollution or job losses).</div></div>
            <div class="tip-card"><div class="t-topic">Business Cycle</div><div class="t-content">Think about how the stages of the business cycle affect different businesses in different ways, and how they respond with different strategies.</div></div>
            <div class="tip-card"><div class="t-topic">Inflation Impact</div><div class="t-content">The impact of inflation on any one business depends very greatly on the rate of inflation and on forecasts for the future.</div></div>
            <div class="tip-card"><div class="t-topic">Interest Rates</div><div class="t-content">Be able to evaluate the impact of changes. Even small changes could be significant for businesses with high debt or selling on credit.</div></div>
            <div class="tip-card"><div class="t-topic">Exchange Rates</div><div class="t-content">You should be able to analyse, with appropriate calculations if necessary, how rises or falls in an exchange rate might impact importers and exporters.</div></div>
        </div>
    </div>

    <div class="formula-section">
        <h3 class="chapter-title" style="border-color:#FFD700;">Strategy & Planning</h3>
        <div class="formula-grid">
            <div class="tip-card"><div class="t-topic">SWOT Analysis</div><div class="t-content">Some questions ask you to undertake a SWOT analysis, while others ask you to evaluate the technique. Read the question carefully.</div></div>
            <div class="tip-card"><div class="t-topic">Mergers and Takeovers</div><div class="t-content">Start by identifying what type it is. Remember that they often cause businesses as many problems as they solve.</div></div>
            <div class="tip-card"><div class="t-topic">Contextual Planning</div><div class="t-content">Explain that the relative importance of planning factors will vary from business to business (e.g. luxury goods vs. small company limits).</div></div>
            <div class="tip-card"><div class="t-topic">Analyzing Change</div><div class="t-content">When discussing how change will affect strategies, try to analyse whether the change is incremental or dramatic, anticipated or unanticipated.</div></div>
            <div class="tip-card"><div class="t-topic">Resistance</div><div class="t-content">When discussing resistance to changes, try to think of the leadership style being used to implement the change.</div></div>
            <div class="tip-card"><div class="t-topic">Contingency Planning</div><div class="t-content">An excellent way to show evaluative skills is to explain that contingency planning does not guarantee that disasters will not occur, but prepares the business for less impact.</div></div>
            <div class="tip-card"><div class="t-topic">Delayering and Delegation</div><div class="t-content">You show very good understanding if you explain that removing layers of middle management must lead to higher levels of delegation.</div></div>
            <div class="tip-card"><div class="t-topic">Structure and Communication</div><div class="t-content">Try to link communication effectiveness with organisational structure. Traditional structures use vertical, matrix uses horizontal.</div></div>
            <div class="tip-card"><div class="t-topic">Formal Networks</div><div class="t-content">When discussing suitable communication methods, try to assess which formal communication network would be most appropriate.</div></div>
            <div class="tip-card"><div class="t-topic">Theory References</div><div class="t-content">When answering a question about leadership, incorporate a reference to one or more leadership theories to give a clear business focus.</div></div>
            <div class="tip-card"><div class="t-topic">HRM Evaluation</div><div class="t-content">You will not be asked detailed questions about IT/AI applications, but be prepared to evaluate their benefits and limitations for HRM.</div></div>
        </div>
    </div>

    <div class="formula-section">
        <h3 class="chapter-title" style="border-color:#FFD700;">Marketing</h3>
        <div class="formula-grid">
            <div class="tip-card"><div class="t-topic">Elasticity Caution</div><div class="t-content">When commenting on an elasticity calculation, you should never assume the result will be accurate and relevant for future changes.</div></div>
            <div class="tip-card"><div class="t-topic">R&D Evaluation</div><div class="t-content">When evaluating R&D, do not assume success is guaranteed by spending more; some inventions will simply not be commercially successful.</div></div>
            <div class="tip-card"><div class="t-topic">IT/AI Impact</div><div class="t-content">You only need to understand their general impact on the role of the marketing department and data analysis, not specific technical applications.</div></div>
            <div class="tip-card"><div class="t-topic">International Strategy</div><div class="t-content">Keep up-to-date with business practices and legal changes in your own country. You may be asked to evaluate a strategy used by a business operating there.</div></div>
        </div>
    </div>

    <div class="formula-section">
        <h3 class="chapter-title" style="border-color:#FFD700;">Operations & Finance</h3>
        <div class="formula-grid">
            <div class="tip-card"><div class="t-topic">Relocation Evaluation</div><div class="t-content">When answering questions about business location, show evaluation by suggesting that the 'best' location will not always remain competitive.</div></div>
            <div class="tip-card"><div class="t-topic">Scale Application</div><div class="t-content">When answering questions about economies of scale, make sure your answer is applied to the business specified in the question.</div></div>
            <div class="tip-card"><div class="t-topic">Scale vs. Output</div><div class="t-content">Do not confuse 'producing more' with increasing the scale of operations. Changing scale means using more (or less) of all resources.</div></div>
            <div class="tip-card"><div class="t-topic">Consumer Expectations</div><div class="t-content">Quality is often viewed as an absolute concept and not a relative one. In answers, quality must be explained with reference to the expectations of target market consumers.</div></div>
            <div class="tip-card"><div class="t-topic">Small Business Quality</div><div class="t-content">Show that quality is not just an issue for large businesses. Small firms also need to consider this to maintain customer loyalty.</div></div>
            <div class="tip-card"><div class="t-topic">Decision Influences</div><div class="t-content">Be prepared to analyse the influence of the availability of human, marketing, and financial resources on strategic operations decisions.</div></div>
            <div class="tip-card"><div class="t-topic">IT/AI in Operations</div><div class="t-content">Be prepared to evaluate the benefits and limitations of IT and AI for business operations without needing to know detailed technical applications.</div></div>
            <div class="tip-card"><div class="t-topic">Kaizen Link</div><div class="t-content">It would be good analysis to link the kaizen principle to the work of Herzberg on job enrichment.</div></div>
            <div class="tip-card"><div class="t-topic">CPA Evaluation</div><div class="t-content">You could evaluate CPA techniques by suggesting that no planning technique, however good, can ensure that a project will reach a successful conclusion.</div></div>
            <div class="tip-card"><div class="t-topic">Accounting Structure</div><div class="t-content">If a question asks you to amend a statement of profit or loss, or a statement of financial position, always use the same structure as shown in the case study.</div></div>
            <div class="tip-card"><div class="t-topic">Evaluation Limits</div><div class="t-content">If a question needs an evaluative answer regarding increasing profitability, it is very important that you consider at least one reason why your suggestion might not be effective.</div></div>
            <div class="tip-card"><div class="t-topic">Ratio Accuracy</div><div class="t-content">When commenting on ratio results, it is often advisable to question the accuracy of the data and explain the limitations of using a limited number of results.</div></div>
            <div class="tip-card"><div class="t-topic">Formatting Calculations</div><div class="t-content">When calculating investment appraisal methods, you are advised to lay out your working carefully, using the forms of table used in this chapter.</div></div>
            <div class="tip-card"><div class="t-topic">Qualitative Factors</div><div class="t-content">Unless the question asks only for numerical factors, your answers should include an assessment of qualitative factors too in investment appraisal.</div></div>
            <div class="tip-card"><div class="t-topic">Strategy Timescales</div><div class="t-content">An excellent way to demonstrate evaluation is to make a clear distinction between the impact of a new strategy on ratios in the short term compared to the long term.</div></div>
        </div>
    </div>
</div>

<div id="view-scorecard" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:20px;">
        <div>
            <h2 style="font-size:2rem; color:var(--text-dark);">Performance Analytics</h2>
            <p style="color:#888;">Track your progress across all exam series</p>
        </div>
        <button class="reset-icon-btn" onclick="resetAll()">‚ö† WIPE DATA</button>
    </div>
    <div id="stats-overview" class="stats-container"></div>
    <div id="score-table-container"></div>
</div>

<div id="view-workspace" class="hidden">
    <button class="nav-btn" onclick="backToDash()" style="margin-bottom:10px;">‚Üê Back to Papers</button>
    <div class="toggle-insert" onclick="toggleInsert()">üìñ Toggle PDF Case Study</div>
    <div class="workspace">
        <div class="insert-panel" id="insert-panel">
            <button class="maximize-insert-btn" onclick="toggleInsertMaximize()">‚§¢ Maximize</button>
            <iframe id="insert-pdf" class="insert-pdf-frame" src=""></iframe>
        </div>
        <div class="questions-panel" id="questions-container"></div>
    </div>
</div>

<div id="view-leaderboard" class="hidden">
    <div style="text-align:center; margin-bottom:40px;">
        <h2 style="font-size:2.5rem; color:var(--lime-dark); font-family:'Playfair Display', serif;">üèÜ Class Leaderboard</h2>
        <p style="color:#666;">Top performers in Business Practice</p>
    </div>
    <div id="leaderboard-container">
        </div>
</div>

<div id="chat-overlay" class="chat-overlay hidden" onclick="toggleChat()"></div>
<div id="chat-panel" class="chat-panel">
    <div class="chat-header">
        <h3 style="margin: 0; color: white;">üí¨ Class Study Group</h3>
        <button onclick="toggleChat()" style="background: transparent; border: none; color: white; font-size: 1.5rem; cursor: pointer;">√ó</button>
    </div>
    <div id="chat-messages" class="chat-messages">
        <div style="text-align: center; color: #888; margin-top: 20px;">Welcome to the study chat!</div>
    </div>
    
    <div id="reply-preview-bar" class="reply-preview">
        <div>
            <strong id="reply-preview-name" style="color: var(--lime-dark); font-size: 0.75rem;"></strong><br>
            <span id="reply-preview-text" style="color: #666; font-size: 0.85rem;"></span>
        </div>
        <button onclick="cancelReply()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #888;">√ó</button>
    </div>

    <div class="chat-input-area">
        <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off" onkeypress="handleChatEnter(event)">
        <button onclick="sendChatMessage()" style="background: var(--lime-dark); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">Send</button>
    </div>
</div>

</div>
</div>

<script>

// === CHAT UI LOGIC ===
function toggleChat() {
    const panel = document.getElementById('chat-panel');
    const overlay = document.getElementById('chat-overlay');
    const badge = document.getElementById('unread-badge'); 
    
    panel.classList.toggle('open');
    if (panel.classList.contains('open')) {
        overlay.classList.remove('hidden');
        if (badge) badge.classList.add('hidden'); 
        
        // üß† NEW: Remember the exact millisecond you opened the chat!
        localStorage.setItem('habibi_chat_last_read', Date.now());
    } else {
        overlay.classList.add('hidden');
    }
}

// === AUTHORIZED USERS LIST ===
const ALLOWED_USERS = {
    "Jesan.Equebal": "virgin",
    "Newton.Mondal": "anime",
    "Sarwar.Alam": "suspension",
    "Aadrita.Mukhopadhyay": "ipmat",
    "Shinjan.Garain": "xxx",
    "Debraj.Mondal": "indore",
    "Abdul.Subhan": "biology",
    "Biswajit.Saha": "general",
    "Surjayu.Sanyal": "rizz",
    "Shreyas.Bhattacharya": "A....",
    "Ayush.Paul": "ayush",
    "Abdul.Rehan": "jipmat"
};

// === ORIGINAL PAPER DATA + CORRECTED 2024 QUESTIONS ===
const paperData = {
/* 2025 SERIES */
'2025_on_31': { title: "Pedro's Perfect Pies (PPP)", pdf: "9609_w25_in_31.pdf", questions: [ { n:'1', m:8, t:'Analyse two likely impacts on PPP of the changing external influences.', l:'150-225'}, { n:'2', m:8, t:'Analyse two benefits to PPP of using quality assurance.', l:'150-225'}, { n:'3(a)', m:2, t:'Using Table 1.3, calculate the payback period for PPP\'s new machine.'}, { n:'3(b)', m:2, t:'Using Table 1.3, calculate the ARR for PPP\'s new machine.'}, { n:'3(c)', m:12, t:'Evaluate whether PPP should invest in the new machine.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the monthly revenue from the sales of the classic pie after the price increase.'}, { n:'4(b)', m:12, t:'Evaluate the usefulness to PPP of elasticity measures.', l:'250-350'}, { n:'5', m:12, t:'Evaluate the importance of emotional intelligence to Pedro\'s leadership.', l:'250-350'} ] },
'2025_on_32': { title: "Komate Tropical Juice (KTJ)", pdf: "9609_w25_in_32.pdf", questions: [ { n:'1', m:8, t:'Analyse one advantage and one disadvantage to KTJ of delegation.', l:'150-225'}, { n:'2', m:8, t:'Analyse two impacts on KTJ of its commitment to CSR.', l:'150-225'}, { n:'3(a)', m:2, t:'Calculate the payback period of the country C location.'}, { n:'3(b)', m:2, t:'Calculate the ARR of the country D location.'}, { n:'3(c)', m:12, t:'Evaluate which location KTJ should choose for its new factory.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the four period centred moving average for Quarter 1 2025.'}, { n:'4(b)', m:12, t:'Evaluate the usefulness of time series analysis to KTJ.', l:'250-350'}, { n:'5', m:12, t:'Evaluate the likely impact on KTJ of fluctuations in the exchange rate.', l:'250-350'} ] },
'2025_on_33': { title: "Lithium Battery Metals (LBM)", pdf: "9609_w25_in_33.pdf", questions: [ { n:'1', m:8, t:'Analyse two advantages to the government of country G from nationalisation.', l:'150-225'}, { n:'2', m:8, t:'Analyse one benefit and one limitation of sales forecasting to LBM.', l:'150-225'}, { n:'3(a)', m:2, t:'Using Table 1.1, calculate the payback period.'}, { n:'3(b)', m:2, t:'Using Table 1.1, calculate the NPV over six years discounted at 8%.'}, { n:'3(c)', m:12, t:'Evaluate LBM\'s decision to go ahead with the hot water mine.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate total float for activity C and minimum project duration.'}, { n:'4(b)', m:12, t:'Evaluate the importance of CPA to the success of the hard rock mine.', l:'250-350'}, { n:'5', m:12, t:'Evaluate LBM\'s decision to use two different approaches to HRM.', l:'250-350'} ] },
'2025_mj_31': { title: "Wisdom Shoes (WS)", pdf: "9609_s25_in_31.pdf", questions: [ { n:'1', m:8, t:'Analyse two advantages to WS of using an environmental audit.', l:'150-225'}, { n:'2', m:8, t:'Analyse two benefits to WS of Enterprise Resource Planning (ERP).', l:'150-225'}, { n:'3(a)', m:2, t:'Refer to Table 1.4. Calculate the change in dividend yield.'}, { n:'3(b)', m:2, t:'Refer to Table 1.4. Calculate the change in P/E ratio.'}, { n:'3(c)', m:12, t:'Evaluate the likely impact on WS shareholders of the proposed changes.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the inventory turnover ratio.'}, { n:'4(b)', m:12, t:'Evaluate the usefulness of ratio analysis to WS directors.', l:'250-350'}, { n:'5', m:12, t:'Evaluate the importance of environmental targets to WS success.', l:'250-350'} ] },
'2025_mj_32': { title: "Pura AI Robots (PAIR)", pdf: "9609_s25_in_32.pdf", questions: [ { n:'1', m:8, t:'Analyse two benefits to PAIR of contingency planning.', l:'150-225'}, { n:'2', m:8, t:'Analyse two likely causes of the failure of the battery supplier.', l:'150-225'}, { n:'3(a)', m:2, t:'Calculate the capacity utilisation for 2025.'}, { n:'3(b)', m:2, t:'Calculate the increase in profit margin.'}, { n:'3(c)', m:12, t:'Evaluate the likely impact on PAIR of the decision to increase investment in R&D.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the total float for the critical path.'}, { n:'4(b)', m:12, t:'Evaluate the usefulness of Critical Path Analysis (CPA) to PAIR.', l:'250-350'}, { n:'5', m:12, t:'Evaluate the extent to which PAIRs future success depends on external influences.', l:'250-350'} ] },
'2025_mj_33': { title: "We Care Products (WCP)", pdf: "9609_s25_in_33.pdf", questions: [ { n:'1', m:8, t:'Analyse two ways the external influences referred to in lines 8-12 may impact on WCP.', l:'150-225'}, { n:'2', m:8, t:'Analyse two benefits to WCP of its social objectives.', l:'150-225'}, { n:'3(a)', m:2, t:'Calculate the labour turnover rate at GC.'}, { n:'3(b)', m:2, t:'Calculate the cost per unit.'}, { n:'3(c)', m:12, t:'Evaluate whether Aldin should change the HRM approach at GC.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the marketing budget variance.'}, { n:'4(b)', m:12, t:'Evaluate the effectiveness of WCP‚Äôs marketing strategy.', l:'250-350'}, { n:'5', m:12, t:'Evaluate the likely impact on WCP of the takeover of GC.', l:'250-350'} ] },
'2025_fm_32': { title: "Iyipada (IPA)", pdf: "9609_m25_in_32.pdf", questions: [ { n:'1', m:8, t:'Analyse one advantage and one disadvantage to IPA of changing employment contracts.', l:'150-225'}, { n:'2', m:8, t:'Analyse two methods to improve IPA\'s liquidity.', l:'150-225'}, { n:'3(a)', m:2, t:'Calculate, for 2024, IPA\'s market share.'}, { n:'3(b)', m:2, t:'Calculate, for 2025, the expected percentage market growth.'}, { n:'3(c)', m:12, t:'Evaluate the Marketing Director\'s proposed changes to IPA\'s marketing mix.', l:'250-350'}, { n:'4(a)', m:2, t:'Complete nodes 5 and 6 on the network diagram.'}, { n:'4(b)', m:2, t:'Calculate the total float for Activity F.'}, { n:'4(c)', m:12, t:'Evaluate the benefit to IPA of Critical Path Analysis (CPA).', l:'250-350'}, { n:'5', m:12, t:'Evaluate the most likely impact on IPA of the fiscal and monetary policy changes.', l:'250-350'} ] },

/* 2024 SERIES (WITH CORRECTED QUESTIONS) */
'2024_on_31': { title: "TopoChoc Enterprises (TC)", pdf: "9609_w24_in_31.pdf", questions: [ { n:'1', m:8, t:'Analyse two benefits to TC of marketing planning for the new range of chocolate bars.', l:'150-225'}, { n:'2', m:8, t:'Analyse two advantages to TC of setting SMART business objectives.', l:'150-225'}, { n:'3(a)', m:2, t:'Calculate the current ratio for 2023.'}, { n:'3(b)', m:2, t:'Calculate the acid test ratio for 2023.'}, { n:'3(c)', m:12, t:'Evaluate whether the directors should worry about TCs liquidity.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the contribution of one chocolate bar.'}, { n:'4(b)', m:12, t:'Evaluate the proposal to produce chocolate bars.', l:'250-350'}, { n:'5', m:12, t:'Evaluate the importance of Total Quality Management (TQM) to TC.', l:'250-350'} ] },
'2024_on_32': { title: "Habesha Clean Cooking (HCC)", pdf: "9609_w24_in_32.pdf", questions: [ { n:'1', m:8, t:'Analyse two impacts on HCC of the increase in competition in country E.', l:'150-225'}, { n:'2', m:8, t:'Analyse two advantages to HCC of being a social enterprise.', l:'150-225'}, { n:'3(a)', m:2, t:'Calculate the capacity utilisation for the Wonder Stove in 2023.'}, { n:'3(b)', m:2, t:'Calculate the increase in profit if production is outsourced.'}, { n:'3(c)', m:12, t:'Evaluate the decision to outsource production of the Wonder Stove.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the EST and LFT for activity F.'}, { n:'4(b)', m:12, t:'Evaluate the usefulness of Critical Path Analysis (CPA) to HCC.', l:'250-350'}, { n:'5', m:12, t:'Evaluate the importance of business planning to the success of HCCs expansion into country K.', l:'250-350'} ] },
'2024_on_33': { title: "Australasia Fitness Factory (AFF)", pdf: "9609_w24_in_33.pdf", questions: [ { n:'1', m:8, t:'Analyse two threats to AFF from changes in its external environment.', l:'150-225'}, { n:'2', m:8, t:'Analyse one advantage and one disadvantage to AFF of being a public limited company.', l:'150-225'}, { n:'3(a)', m:2, t:'Calculate the return on capital employed (ROCE) for 2023.'}, { n:'3(b)', m:2, t:'Calculate the gearing ratio for 2023.'}, { n:'3(c)', m:12, t:'Evaluate the likely impact on AFF shareholders of the new share issue.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the dividend yield for 2022.'}, { n:'4(b)', m:12, t:'Evaluate the usefulness of ratio analysis to AFFs directors.', l:'250-350'}, { n:'5', m:12, t:'Evaluate whether TQM is the best way to solve customer complaint problems.', l:'250-350'} ] },
'2024_mj_31': { title: "Gordy Building Supplies (GBS)", pdf: "9609_s24_in_31.pdf", questions: [ { n:'1', m:8, t:'Analyse two advantages to GBS of using flexible part-time employment contracts.', l:'150-225'}, { n:'2', m:8, t:'Analyse two disadvantages to GBS of its proposed communication process innovation.', l:'150-225'}, { n:'3(a)', m:2, t:'Calculate the gearing ratio.'}, { n:'3(b)', m:2, t:'Calculate the return on capital employed (ROCE).'}, { n:'3(c)', m:12, t:'Evaluate the usefulness of ratio analysis to GBS‚Äôs directors.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the total float for activity C.'}, { n:'4(b)', m:12, t:'Evaluate the usefulness of Critical Path Analysis (CPA) to GBS.', l:'250-350'}, { n:'5', m:12, t:'Evaluate the extent to which corporate social responsibility (CSR) should influence GBS‚Äôs decision to expand into new land.', l:'250-350'} ] },
'2024_mj_32': { title: "Soymai Farms (SF)", pdf: "9609_s24_in_32.pdf", questions: [ { n:'1', m:8, t:'Analyse two advantages to SF of using flexible employment contracts.', l:'150-225'}, { n:'2', m:8, t:'Analyse two problems SF may experience when implementing total quality management (TQM).', l:'150-225'}, { n:'3(a)', m:2, t:'Refer to Table 1.1. Calculate the sales volume variation for Quarter 1 2023.'}, { n:'3(b)', m:2, t:'Refer to Table 1.1. Calculate the centred quarterly moving average for Quarter 2 2023.'}, { n:'3(c)', m:12, t:'Evaluate the usefulness of sales forecasting to SF.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the current capacity utilisation of the factory.'}, { n:'4(b)', m:12, t:'Evaluate the decision to outsource production of Sosoy Ice Cream.', l:'250-350'}, { n:'5', m:12, t:'Evaluate the impact on SF of country B becoming a member of the NFTA international trading agreement.', l:'250-350'} ] },
'2024_mj_33': { title: "Sunil's Clothing Company (SCC)", pdf: "9609_s24_in_33.pdf", questions: [ { n:'1', m:8, t:'Analyse two impacts on SCC of the changing external influences in country Z.', l:'150-225'}, { n:'2', m:8, t:'Analyse two disadvantages to SCC of the proposed new factory.', l:'150-225'}, { n:'3(a)', m:2, t:'Calculate the promotional elasticity of demand.'}, { n:'3(b)', m:2, t:'Calculate the price elasticity of demand.'}, { n:'3(c)', m:12, t:'Evaluate the usefulness of elasticity data to SCC.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the total float for activity B.'}, { n:'4(b)', m:12, t:'Evaluate the importance of Critical Path Analysis (CPA) to the success of the new factory.', l:'250-350'}, { n:'5', m:12, t:'Evaluate whether Sunil should use a soft or hard approach to human resource management.', l:'250-350'} ] },
'2024_fm_32': { title: "Clean Delivery (CD)", pdf: "9609_m24_in_32.pdf", questions: [ { n:'1', m:8, t:'Analyse two benefits to CD resulting from internal economies of scale.', l:'150-225'}, { n:'2', m:8, t:'Analyse two advantages to CD of changing to a geographical organisational structure.', l:'150-225'}, { n:'3(a)', m:2, t:'Refer to Table 1.1. Calculate the Price Earnings (P/E) ratio for 2024.'}, { n:'3(b)', m:2, t:'Refer to Table 1.1. Calculate the Return on Capital Employed (ROCE) for 2024.'}, { n:'3(c)', m:12, t:'Evaluate the usefulness of ratio analysis to CD‚Äôs directors.', l:'250-350'}, { n:'4(a)', m:4, t:'Calculate the difference in capacity utilisation between 2022 and 2023.'}, { n:'4(b)', m:12, t:'Evaluate the importance of research and development (R&D) to CD‚Äôs future success.', l:'250-350'}, { n:'5', m:12, t:'Evaluate the impact on CD of the appreciation of country K‚Äôs exchange rate.', l:'250-350'} ] }
};

function getUser() { return localStorage.getItem('user'); }
function setUser(u) { localStorage.setItem('user', u); }
function getAttempts(u) { return JSON.parse(localStorage.getItem(`attempts_${u}`) || '{}'); }

function saveAttempt(u, pid, qn, data) {
    const atts = getAttempts(u);
    if(!atts[pid]) atts[pid] = {};
    atts[pid][qn] = data;
    localStorage.setItem(`attempts_${u}`, JSON.stringify(atts));
    // SYNC ON SAVE
    setTimeout(syncScore, 500);
}

function tryLogin() {
    const u = document.getElementById('u-in').value.trim();
    const p = document.getElementById('p-in').value.trim();
    
    // NEW RESTRICTED LOGIN CHECK
    if(ALLOWED_USERS[u] && ALLOWED_USERS[u] === p) {
        setUser(u);
        const name = u.split('.')[0] || u;
        document.getElementById('welcome-msg').innerText = `Welcome, ${name.charAt(0).toUpperCase() + name.slice(1)}`;
        document.getElementById('login-layer').classList.add('hidden');
        document.getElementById('app-layer').classList.remove('hidden');
        setView('papers');
        syncScore(); // Sync on login
    } else { 
        alert("Invalid Username or Password."); 
    }
}

function doLogout() { localStorage.removeItem('user'); location.reload(); }

function setView(viewName) {
    ['papers', 'scorecard', 'workspace', 'formulae', 'definitions', 'leaderboard', 'tips'].forEach(v => {
        const el = document.getElementById(`view-${v}`);
        if(el) el.classList.add('hidden');
    });
    document.getElementById(`view-${viewName}`).classList.remove('hidden');
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
        if(btn.innerText.toLowerCase().includes(viewName.replace('leaderboard','üèÜ').replace('scorecard','scorecard'))) btn.classList.add('active');
    });
    if(viewName === 'scorecard') renderScorecard();
    if(viewName === 'leaderboard') loadLeaderboard();
}

function backToDash() { setView('papers'); }
function toggleInsert() { document.getElementById('insert-panel').classList.toggle('show'); }

function openPaper(pid) {
    const data = paperData[pid];
    const u = getUser();
    const attempts = getAttempts(u)[pid] || {};

    document.getElementById('insert-pdf').src = data.pdf;
    
    let qHtml = `<h2 style="margin-bottom:20px; color:var(--lime-dark);">${data.title}</h2>`;
    data.questions.forEach(q => {
        const att = attempts[q.n] || {};
        const done = att.score !== undefined;
        
        let aoHtml = '';
        if(done) {
            aoHtml = `<div style="display:flex; gap:10px; flex-wrap:wrap; margin:15px 0;">
            <span class="score-badge" style="background:#fff; font-size:0.8rem;">AO1: ${att.ao1 || '-'}</span>
            <span class="score-badge" style="background:#fff; font-size:0.8rem;">AO2: ${att.ao2 || '-'}</span>
            <span class="score-badge" style="background:#fff; font-size:0.8rem;">AO3: ${att.ao3 || '-'}</span>
            <span class="score-badge" style="background:#fff; font-size:0.8rem;">AO4: ${att.ao4 || '-'}</span>
            </div>`;
        }

        qHtml += `<div class="question-card">
            <div class="q-header"><strong>Q${q.n}</strong><span class="q-badge">${q.m} Marks</span></div>
            <p style="font-weight:600; margin-bottom:10px;">${q.t}</p>
            ${q.l ? `<p class="word-limit">Limit: ${q.l} words</p>` : ''}
            
            <button class="expand-btn" id="btn_exp_${pid}_${q.n}" onclick="toggleExpand('ans_${pid}_${q.n}', 'btn_exp_${pid}_${q.n}')">‚§¢ Expand</button>
            <textarea id="ans_${pid}_${q.n}" oninput="updateWordCount(this, '${q.l}')">${att.answer || ''}</textarea>
            <div id="wc_${pid}_${q.n}" class="word-count">0 words</div>

            <button class="submit-btn ${done ? 'completed' : ''}" onclick="submitAnswer('${pid}', '${q.n}')">${done ? '‚úì Re-Evaluate' : 'Submit for Strict Marking'}</button>
            
            ${done ? `<div class="feedback-box">
                <h3>Score: ${att.score}/${q.m}</h3>
                ${aoHtml}
                <p><strong>Strengths:</strong> ${att.strengths}</p>
                <p><strong>Improvements:</strong> <span style="color:#d63031">${att.weaknesses}</span></p>
                <div class="model-ans-box"><strong>Model Answer:</strong><br>${att.modelAnswer}</div>
            </div>` : ''}
        </div>`;
    });
    document.getElementById('questions-container').innerHTML = qHtml;
    setView('workspace');
    
    // Init word counts
    data.questions.forEach(q => {
        const el = document.getElementById(`ans_${pid}_${q.n}`);
        if(el) updateWordCount(el, q.l);
    });
}

function updateWordCount(el, limitStr) {
    if(!limitStr) return;
    const count = el.value.trim().split(/\s+/).filter(w => w.length > 0).length;
    // FIX: Using replace is safer than splitting by underscore since paper IDs contain underscores
    const wcId = el.id.replace('ans_', 'wc_');
    const wcEl = document.getElementById(wcId);
    
    if(wcEl) {
        const [min, max] = limitStr.split('-').map(Number);
        wcEl.innerText = `${count} words (${limitStr})`;
        
        if(count < min || count > max) {
            wcEl.classList.add('bad'); wcEl.classList.remove('good');
        } else {
            wcEl.classList.add('good'); wcEl.classList.remove('bad');
        }
    }
}

function toggleExpand(textAreaId, btnId) {
    const el = document.getElementById(textAreaId);
    const btn = document.getElementById(btnId);
    if(el) {
        el.classList.toggle('expanded');
        if(el.classList.contains('expanded')) {
            btn.innerText = "‚§° Shrink";
        } else {
            btn.innerText = "‚§¢ Expand";
        }
    }
}

function toggleInsertMaximize() {
    const el = document.getElementById('insert-panel');
    const btn = document.querySelector('.maximize-insert-btn');
    el.classList.toggle('fullscreen');
    
    if(el.classList.contains('fullscreen')) {
        btn.innerText = "‚§° Minimize";
    } else {
        btn.innerText = "‚§¢ Maximize";
    }
}

async function submitAnswer(pid, qn) {
    const el = document.getElementById(`ans_${pid}_${qn}`);
    const btn = event.target;
    const ans = el.value.trim();
    if(!ans) return alert("Please write an answer first.");

    btn.innerText = "‚è≥ Strict Marking...";
    btn.disabled = true;

    const qData = paperData[pid].questions.find(q => q.n === qn);

    try {
        const res = await fetch('https://ultimate-exam-guide.onrender.com/mark', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                question: qData.t,
                case_study: `Refer to attached PDF for ${paperData[pid].title}.`,
                answer: ans,
                marks: qData.m
            })
        });

        const json = await res.json();
        saveAttempt(getUser(), pid, qn, {
            answer: ans,
            score: json.score,
            ao1: json.ao1, ao2: json.ao2, ao3: json.ao3, ao4: json.ao4,
            strengths: json.strengths,
            weaknesses: json.weaknesses,
            modelAnswer: json.model_answer
        });
        openPaper(pid);

    } catch(e) {
        console.error(e);
        alert("Error: Server not responding.");
        btn.innerText = "Retry";
        btn.disabled = false;
    }
}

// === ADMIN DELETE FUNCTION ===
async function deleteUser(name) {
    if(!confirm(`Are you sure you want to delete ${name} from the leaderboard?`)) return;
    try {
        const res = await fetch(`https://ultimate-exam-guide.onrender.com/delete_user?name=${name}`);
        if(res.ok) {
            alert(`Deleted ${name}`);
            loadLeaderboard(); 
        } else {
            alert("Failed to delete. Make sure app.py is updated.");
        }
    } catch(e) { console.error(e); alert("Connection error."); }
}

// === LEADERBOARD LOGIC ===
async function syncScore() {
    const u = getUser();
    if(!u) return;
    
    const atts = getAttempts(u);
    let totalScore = 0;
    let papersDone = 0;
    
    // Calculate total score locally
    Object.keys(atts).forEach(pid => {
        let hasScore = false;
        Object.values(atts[pid]).forEach(q => {
            if(q.score) {
                totalScore += q.score;
                hasScore = true;
            }
        });
        if(hasScore) papersDone++;
    });

    // Send to backend
    try {
        await fetch('https://ultimate-exam-guide.onrender.com/update_score', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                username: u,
                total_score: totalScore,
                papers_completed: papersDone
            })
        });
    } catch(e) { console.error("Sync failed", e); }
}

async function loadLeaderboard() {
    const container = document.getElementById('leaderboard-container');
    container.innerHTML = "‚è≥ Fetching rankings...";
    
    try {
        const res = await fetch('https://ultimate-exam-guide.onrender.com/leaderboard');
        const data = await res.json();
        const isAdmin = (getUser() === 'admin');
        
        let html = `<table class="modern-table"><thead><tr><th>Rank</th><th>Student</th><th>Papers</th><th>Total Score</th>${isAdmin ? '<th>Action</th>' : ''}</tr></thead><tbody>`;
        
        data.forEach((entry, index) => {
            const name = entry[0];
            const stats = entry[1];
            let badge = '';
            if(index === 0) badge = 'ü•á';
            else if(index === 1) badge = 'ü•à';
            else if(index === 2) badge = 'ü•â';
            else badge = `#${index+1}`;
            
            let actionBtn = '';
            if(isAdmin) {
                actionBtn = `<button class="reset-icon-btn" style="padding:2px 8px; font-size:12px;" onclick="deleteUser('${name}')">‚ùå</button>`;
            }
            
            html += `<tr>
                <td><span style="font-size:1.2rem; font-weight:700;">${badge}</span></td>
                <td style="font-weight:700; color:var(--text-dark);">${name}</td>
                <td>${stats.papers}</td>
                <td><span class="score-badge">${stats.score}</span></td>
                ${isAdmin ? `<td>${actionBtn}</td>` : ''}
            </tr>`;
        });
        
        html += `</tbody></table>`;
        container.innerHTML = html;
    } catch(e) {
        container.innerHTML = `<p style="color:red; font-weight:600;">Failed to load leaderboard. Server might be sleeping.</p>`;
    }
}

function renderScorecard() {
    const u = getUser();
    const allAtts = getAttempts(u);
    let totalQ = 0, totalAns = 0, totalScore = 0, possibleScore = 0, papersStarted = 0;
    let rows = '';

    Object.keys(paperData).forEach(pid => {
        const pAtts = allAtts[pid] || {};
        const qs = paperData[pid].questions;
        const answeredCount = Object.keys(pAtts).length;
        if(answeredCount > 0) papersStarted++;

        let pScore = 0, pMax = 0;
        qs.forEach(q => {
            pMax += q.m;
            if(pAtts[q.n]) {
                pScore += (pAtts[q.n].score || 0);
                totalScore += (pAtts[q.n].score || 0);
                possibleScore += q.m;
            }
        });
        totalQ += qs.length;
        totalAns += answeredCount;

        const percent = (answeredCount / qs.length) * 100;

        rows += `<tr>
        <td><div style="font-weight:700;">${paperData[pid].title}</div><div style="font-size:0.8rem; color:#888;">${pid}</div></td>
        <td><div class="progress-track"><div class="progress-fill" style="width:${percent}%"></div></div> <span style="font-size:0.9rem; font-weight:600;">${answeredCount}/${qs.length}</span></td>
        <td><span class="score-badge">${pScore}/${pMax}</span></td>
        <td>${answeredCount > 0 ? `<button class="reset-icon-btn" onclick="resetPaper('${pid}')">Reset</button>` : '-'}</td>
        </tr>`;
    });

    const accuracy = possibleScore > 0 ? Math.round((totalScore/possibleScore)*100) : 0;

    document.getElementById('stats-overview').innerHTML = `
        <div class="stat-card"><span class="stat-value">${papersStarted}</span><span class="stat-label">Papers Started</span></div>
        <div class="stat-card"><span class="stat-value">${totalAns}</span><span class="stat-label">Questions Solved</span></div>
        <div class="stat-card"><span class="stat-value">${accuracy}%</span><span class="stat-label">Global Accuracy</span></div>
    `;

    document.getElementById('score-table-container').innerHTML = `<table class="modern-table"><thead><tr><th>Paper</th><th>Progress</th><th>Score</th><th>Action</th></tr></thead><tbody>${rows}</tbody></table>`;
    
    // Auto-Sync score when viewing scorecard
    syncScore();
}

function resetPaper(pid) {
    if(confirm("Delete all answers for this paper?")) {
        const u = getUser();
        const atts = getAttempts(u);
        delete atts[pid];
        localStorage.setItem(`attempts_${u}`, JSON.stringify(atts));
        renderScorecard();
    }
}

function resetAll() {
    if(confirm("WIPE ALL DATA?")) { localStorage.clear(); location.reload(); }
}

if(getUser()) {
    const u = getUser();
    const name = u.split('.')[0] || u;
    document.getElementById('welcome-msg').innerText = `Welcome, ${name.charAt(0).toUpperCase() + name.slice(1)}`;
    document.getElementById('login-layer').classList.add('hidden');
    document.getElementById('app-layer').classList.remove('hidden');
    setView('papers');
    // Sync on auto-login
    setTimeout(syncScore, 1000);
}
</script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded, onChildChanged, onChildRemoved, serverTimestamp, remove, update } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDQdGnwbZq_V7Hm6V8IAVz7bnTt25H622s",
    authDomain: "habibi-studies-chat.firebaseapp.com",
    databaseURL: "https://habibi-studies-chat-default-rtdb.firebaseio.com",
    projectId: "habibi-studies-chat",
    storageBucket: "habibi-studies-chat.firebasestorage.app",
    messagingSenderId: "877923996625",
    appId: "1:877923996625:web:9e493c16c618c46a11c6f0"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRef = ref(db, 'class_chat');

  let replyingToData = null; // Remembers who you are replying to

  function getChatUser() {
      return localStorage.getItem('username') || localStorage.getItem('user') || localStorage.getItem('currentUser') || "Student";
  }

  // --- SEND MESSAGES ---
  window.sendChatMessage = function() {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      const user = getChatUser(); 

      if (text !== '') {
          const messageData = { name: user, text: text, timestamp: serverTimestamp() };
          
          if (replyingToData) messageData.replyTo = replyingToData; // Attach quote if replying

          push(chatRef, messageData).catch(error => alert("Firebase Error: " + error.message));
          
          input.value = ''; 
          window.cancelReply(); // Clear the reply box
      }
  };

  window.handleChatEnter = function(event) {
      if (event.key === 'Enter') window.sendChatMessage();
  };

  // --- EDIT, DELETE & REPLY LOGIC ---
  window.deleteMessage = function(msgId) {
      if(confirm("Delete this message for everyone?")) {
          remove(ref(db, `class_chat/${msgId}`));
      }
  };

  window.editMessage = function(msgId, oldText) {
      const newText = prompt("Edit your message:", oldText);
      if(newText !== null && newText.trim() !== "" && newText !== oldText) {
          update(ref(db, `class_chat/${msgId}`), { text: newText.trim(), edited: true });
      }
  };

  window.replyToMessage = function(name, text) {
      replyingToData = { name: name, text: text };
      document.getElementById('reply-preview-name').innerText = "Replying to " + name.replace('.', ' ');
      document.getElementById('reply-preview-text').innerText = text.length > 40 ? text.substring(0,40) + '...' : text;
      document.getElementById('reply-preview-bar').classList.add('active');
      document.getElementById('chat-input').focus();
  };

  window.cancelReply = function() {
      replyingToData = null;
      document.getElementById('reply-preview-bar').classList.remove('active');
  };

  // --- REAL-TIME RENDERER ---
  const chatMessages = document.getElementById('chat-messages');

  function renderMessage(snapshot) {
      const data = snapshot.val();
      const msgId = snapshot.key; // Unique Firebase ID for each message
      
      const welcome = chatMessages.querySelector('div[style*="text-align: center"]');
      if (welcome) welcome.remove();

      const isMe = data.name === getChatUser();
      const cleanName = data.name ? data.name.replace('.', ' ') : 'Unknown';
      
      // 1. Build Quote Box if it's a reply
      let quoteHtml = '';
      if (data.replyTo) {
          quoteHtml = `
              <div class="quote-box">
                  <strong style="color: var(--lime-dark); font-size: 0.75rem;">${data.replyTo.name.replace('.', ' ')}</strong><br>
                  ${data.replyTo.text}
              </div>`;
      }

      // 2. Build Action Buttons (Hidden until you hover over the message)
      const safeText = data.text.replace(/"/g, '&quot;').replace(/'/g, "\\'");
      let actionsHtml = `
          <div class="msg-actions">
              <button class="msg-action-btn" onclick="replyToMessage('${data.name}', '${safeText}')">‚Ü©Ô∏è Reply</button>
              ${isMe ? `
                  <button class="msg-action-btn" onclick="editMessage('${msgId}', '${safeText}')">‚úèÔ∏è Edit</button>
                  <button class="msg-action-btn" onclick="deleteMessage('${msgId}')">üóëÔ∏è Delete</button>
              ` : ''}
          </div>`;

      // 3. Inject into the DOM
      let msgDiv = document.getElementById(`msg-${msgId}`);
      let isNew = false;
      if (!msgDiv) {
          msgDiv = document.createElement('div');
          msgDiv.id = `msg-${msgId}`;
          isNew = true;
      }

      msgDiv.className = `msg-box ${isMe ? 'me' : 'other'}`;
      msgDiv.innerHTML = `
          <div class="msg-name">${isMe ? 'You' : cleanName}</div>
          <div class="msg-bubble">
              ${quoteHtml}
              <span class="msg-text-content">${data.text}</span>
              ${data.edited ? '<span class="edited-tag">(edited)</span>' : ''}
          </div>
          ${actionsHtml}
      `;
      
      if (isNew) {
          chatMessages.appendChild(msgDiv);
          chatMessages.scrollTop = chatMessages.scrollHeight; 
          
          const panel = document.getElementById('chat-panel');
          const badge = document.getElementById('unread-badge');
          
          // Grab the time you last read the chat (default to 0 if never opened)
          const lastRead = localStorage.getItem('habibi_chat_last_read') || 0;
          
          // Only show red dot if: 
          // 1. Chat is closed, 2. Someone else sent it, AND 3. It was sent AFTER you last checked the chat!
          if (panel && badge && !panel.classList.contains('open') && !isMe) {
              if (data.timestamp && data.timestamp > lastRead) {
                  badge.classList.remove('hidden');
              }
          }
      }
  }

  // FIREBASE REAL-TIME LISTENERS
  onChildAdded(chatRef, renderMessage);   // When a new message arrives
  onChildChanged(chatRef, renderMessage); // When someone edits a message
  onChildRemoved(chatRef, (snapshot) => { // When someone deletes a message
      const el = document.getElementById(`msg-${snapshot.key}`);
      if(el) el.remove();
  });
</script>

</body>
</html>